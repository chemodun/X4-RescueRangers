<?xml version="1.0" encoding="iso-8859-1"?>
<aiscript name="order.rescue.rangers.sector" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="aiscripts.xsd" version="1">
  <order id="RescueRangers" name="{1972092402, 1}" description="{1972092402, 2}" category="navigation" infinite="true">
    <params>
      <param name="homeSector" default="if this.ship.jobmainsector? then this.ship.jobmainsector else this.ship.sector" type="sector" required="true" text="{1972092402, 101}" />
      <param name="homeStation" type="object"  text="{1972092402, 102}" >
        <input_param name="class" value="[class.station]"/>
      </param>
      <param name="shipDormitory" type="object"  text="{1972092402, 103}">
        <input_param name="class" value="[class.ship]"/>
        <input_param name="owner" value="this.ship.trueowner"/>
      </param>
      <param name="debugchance" type="bool" default="0" advanced="true" text="{1041, 10086}" comment="Print debug output">
        <input_param name="truevalue" value="100"/>
        <editable/>
      </param>
    </params>
    <!-- <skill min="20" /> -->
    <requires>
      <match shiptype="shiptype.lasertower" negate="true" />
    </requires>
    <location object="$homeSector" condition="$homeSector.zone.exists" />
  </order>

  <interrupts>
    <handler ref="AttackHandler" />
    <handler ref="MissileLockHandler" />
    <handler ref="ScannedHandler" />
    <handler ref="InspectedHandler" />
    <handler ref="FoundAbandonedHandler" />
    <handler ref="FoundLockboxHandler" />
    <handler>
      <conditions>
        <check_all>
          <event_game_loaded />
          <debug_text text="'%s [%s (%s - %s) at %s] - Game loaded with version %s'.
          [
            player.age,
            this.ship.knownname, 
            this.ship.idcode, 
            this.ship, 
            this.ship.sector.knownname, 
            @$scriptVersion
          ]" debugchance="100"/>
          <check_value value="@$scriptVersion lt 100" />
        </check_all>
      </conditions>
      <actions>
        <debug_to_file directory="'rescuerangers'" name="'debug_' + this.ship.knownname + '_' + this.ship.idcode + '_' + this.ship" 
          text="'[%s (%s - %s) at %s] - Re-init for versions prior to 1.00'
          .[
            this.ship.knownname, 
            this.ship.idcode, 
            this.ship, 
            this.ship.sector.knownname, 
          ]" output="true" append="true" />
        <do_if value="@$scriptVersion lt 100">
          <cancel_all_orders object="this.ship" />
          <create_order object="this.ship" id="'RescueRangers'" default="true">
            <param name="homeSector" value="$homeSector" />
            <param name="homeStation" value="$homeStation" />
            <param name="shipDormitory" value="$shipDormitory" />
          </create_order>
        </do_if>
      </actions>
    </handler>
    <handler>
      <conditions>
        <check_all>
          <event_player_owned_destroyed />
          <debug_text text="'[%s (%s - %s) at %s]:  %s, our : %s (%s - %s) {%s} in sector: %s, target: %s'.
          [
            this.ship.knownname, 
            this.ship.idcode, 
            this.ship, 
            this.ship.sector.knownname, 
            event.name, 
            event.param.name, 
            event.param.idcode, 
            event.param, 
            event.param.class, 
            event.param.sector.knownname, 
            $target
          ]" debugchance="100"/>
<!--           <debug_text text="'[%s (%s - %s) at %s]:  %s, is class ship: %s'.
          [
            this.ship.knownname, 
            this.ship.idcode, 
            this.ship, 
            this.ship.sector.knownname, 
            event.name, 
            event.param.isclass.ship, 
          ]" debugchance="100"/>     -->      
          <check_value value="event.param.isclass.ship" />
<!--           <debug_text text="'[%s (%s - %s) at %s]:  %s, not this ship: %s'.
          [
            this.ship.knownname, 
            this.ship.idcode, 
            this.ship, 
            this.ship.sector.knownname, 
            event.name, 
            event.param != this.ship, 
          ]" debugchance="100"/>       -->              
          <check_value value="event.param != this.ship" />
<!--           <debug_text text="'[%s (%s - %s) at %s]:  %s, right sector: %s'.
          [
            this.ship.knownname, 
            this.ship.idcode, 
            this.ship, 
            this.ship.sector.knownname, 
            event.name, 
            event.param.sector == $homeSector, 
          ]" debugchance="100"/>   -->          
          <check_value value="event.param.sector == $homeSector" />
<!--           <debug_text text="'[%s (%s - %s) at %s]:  %s, can rescue: %s'.
          [
            this.ship.knownname, 
            this.ship.idcode, 
            this.ship, 
            this.ship.sector.knownname, 
            event.name, 
            @$canRescue, 
          ]" debugchance="100"/>             -->
          <check_value value="@$canRescue" />
          <check_value value="$target == null"/>
        </check_all>
      </conditions>
      <actions>
        <debug_to_file directory="'rescuerangers'" name="'debug_' + this.ship.knownname + '_' + this.ship.idcode + '_' + this.ship"
          text="'[%s (%s - %s) at %s] -  %s, our : %s (%s - %s) {%s} in sector: %s'
            .[
              this.ship.knownname, 
              this.ship.idcode, 
              this.ship, 
              this.ship.sector.knownname, 
              event.name, 
              event.param.name, 
              event.param.idcode, 
              event.param, 
              event.param.class, 
              event.param.sector.knownname, 
            ]"
          output="true" append="true" />
        <apply_experience entity="this" experience="'rescue_rangers'" chance="30"/>
        <do_if value="this.ship.people.free">
          <abort_called_scripts resume="findSpacesuits" />
        </do_if>
      </actions>
    </handler>
    <handler>
      <conditions>
        <check_all>
          <event_object_docked_at container="this.ship"/>
          <check_value value="$target != null" />
          <check_value value="event.param == $target" />
        </check_all>
      </conditions>
      <actions>
        <debug_to_file directory="'rescuerangers'" name="'debug_' + this.ship.knownname + '_' + this.ship.idcode + '_' + this.ship"
          text="'[%s (%s - %s) at %s] -  %s, our : %s (%s - %s) {%s} in sector: %s, docked at: %s'
            .[
              this.ship.knownname, 
              this.ship.idcode, 
              this.ship, 
              this.ship.sector.knownname, 
              event.name, 
              event.param.name, 
              event.param.idcode, 
              event.param, 
              event.param.class, 
              event.param.sector.knownname, 
              event.param.dock,
            ]"
          output="true" append="true" />
        <debug_to_file directory="'rescuerangers'" name="'debug_' + this.ship.knownname + '_' + this.ship.idcode + '_' + this.ship" 
          text="'[%s (%s - %s) at %s]  -  After rescue: free before: %s, after: %s. Target: %s (%s - %s) at %s, is operational: %s, is exist: %s, is wreck: %s, is docked: %s'
            .[
              this.ship.knownname, 
              this.ship.idcode, 
              this.ship, 
              this.ship.sector.knownname, 
              $crewFreeCount,
              this.ship.people.free,
              @$target.knownname,
              @$target.idcode,
              @$target,
              @$target.sector.knownname,
              @$target.isoperational,
              @$target.exists,
              @$target.iswreck,
              @$target.dock,
            ]" output="true" append="true" />    
        <set_value name="$target" exact="null" />
        <do_if value="this.ship.people.free lt $crewFreeCount">
          <apply_experience entity="this" experience="'rescue_rangers'" chance="85"/>
        </do_if>
        <do_if value="this.ship.people.free">
          <abort_called_scripts resume="findSpacesuits" />
        </do_if>
        <do_else>
          <abort_called_scripts resume="transferPeople" />
        </do_else>
      </actions>
    </handler>
  </interrupts>
  <init>

    <set_value name="$scriptVersion" exact="100" />

    <set_value name="$target" exact="null" />

    <create_group groupname="$targets" />

    <set_value name="$debugChance" exact="100" />

    <do_if value="$homeSector.isclass.sector" negate="true">
      <set_value name="$homeSector" exact="$homeSector.sector" />
    </do_if>

    <!-- <set_command_action commandaction="commandaction.scanningto" param="$homeLocation.sector" /> -->

    <do_if value="this.ship.people.free">
      <set_value name="$canRescue" exact="true" />
    </do_if>
    <do_else>
      <set_value name="$canRescue" exact="false" />
    </do_else>

    <debug_to_file directory="'rescuerangers'" name="'debug_' + this.ship.knownname + '_' + this.ship.idcode + '_' + this.ship"
      text="'[%s (%s - %s) at %s] - Init version %s. Free: %s. Sector: %s, station: [%s (%s - %s) at %s], dormitory: [%s (%s - %s) at %s], free: %s. Can rescue: %s. Debug chance: %s'
        .[
          this.ship.knownname, 
          this.ship.idcode, 
          this.ship, 
          this.ship.sector.knownname, 
          @$scriptVersion,
          this.ship.people.free,
          @$homeSector.knownname, 
          @$homeStation.knownname, 
          @$homeStation.idcode, 
          @$homeStation, 
          @$homeStation.sector.knownname, 
          @$shipDormitory.knownname, 
          @$shipDormitory.idcode, 
          @$shipDormitory, 
          @$shipDormitory.sector.knownname,
          @$shipDormitory.people.free,
          @$canRescue,
          $debugchance
        ]" output="true" append="true" />

    <set_value name="$crewFreeCount" exact="this.ship.people.free" />

  </init>

  <attention min="unknown">
    <actions>

      <label name="start" />

      <do_if value="this.ship.order" comment="Safety check in case the script is called from non-order script">
        <!-- Required for all infinite orders, no effect in case of finite timeout -->
        <set_order_syncpoint_reached order="this.ship.order" />
      </do_if>

      <debug_to_file directory="'rescuerangers'" name="'debug_' + this.ship.knownname + '_' + this.ship.idcode + '_' + this.ship"
        text="'[%s (%s - %s) at %s]  - homeStation: %s {%s - %s} at %s, dock: %s, parkedat: %s'
          .[
            this.ship.knownname, 
            this.ship.idcode, 
            this.ship, 
            this.ship.sector.knownname, 
            @$homeStation.knownname,
            @$homeStation.idcode,
            @$homeStation,
            @$homeStation.sector.knownname,
            this.ship.dock,
            this.ship.parkedat,
          ]" output="true" append="true" />      

      <do_if value="(this.ship.dock and (this.ship.dock.container == $homeStation)) or (this.ship.parkedat and ((this.ship.parkedat == $homeStation) or this.ship.parkedat.hascontext.{$homeStation}))">
        <wait min="50s" max="170s" />
      </do_if>
      <do_else>
          <debug_to_file directory="'rescuerangers'" name="'debug_' + this.ship.knownname + '_' + this.ship.idcode + '_' + this.ship"
            text="'[%s (%s - %s) at %s]  - going to dock at homeStation: %s {%s - %s} at %s'
              .[
                this.ship.knownname, 
                this.ship.idcode, 
                this.ship, 
                this.ship.sector.knownname, 
                @$homeStation.knownname,
                @$homeStation.idcode,
                @$homeStation,
                @$homeStation.sector.knownname,
              ]" output="true" append="true" />      
          <run_script name="'order.dock'" result="$docked">
            <param name="destination" value="$homeStation"/>
            <!-- <param name="abouttofinish" value="true"/> -->
            <param name="debugchance" value="$debugChance"/>
          </run_script>        
      </do_else>

      <resume label="start" />

      <label name="findSpacesuits" />

      <do_if value="$target == null">

        <find_ship name="$spacesuits" space="this.ship.sector" class="class.spacesuit" docked="false" checkoperational="true"  recursive="true" multiple="true" sortbydistanceto="this.ship">
          <match trueowner="faction.player"/>
        </find_ship>

        <debug_to_file directory="'rescuerangers'" name="'debug_' + this.ship.knownname + '_' + this.ship.idcode + '_' + this.ship"
          text="'[%s (%s - %s) at %s]  -  Spacesuits: found: %s, list: %s'
            .[
              this.ship.knownname, 
              this.ship.idcode, 
              this.ship, 
              this.ship.sector.knownname, 
              @$spacesuits.count,
              @$spacesuits,
            ]" output="true" append="true" />      

        <set_value name="$spacesuitsIndex" exact="1" />
        
        <do_while value="$target == null and $spacesuitsIndex le $spacesuits.count">
          <set_value name="$target" exact="$spacesuits.{$spacesuitsIndex}" />
          <do_if value="@$target.pilot.$toRescueBy" negate="true">
            <set_value name="$target.pilot.$toRescueBy" exact="this.ship.idcode" />
          </do_if>
          <do_else>
            <set_value name="$target" exact="null" />
          </do_else>
          <set_value name="$spacesuitsIndex" exact="$spacesuitsIndex + 1" />
        </do_while>

        <do_if value="$target == null">
          <debug_to_file directory="'rescuerangers'" name="'debug_' + this.ship.knownname + '_' + this.ship.idcode + '_' + this.ship" 
            text="'[%s (%s - %s) at %s]  -  No spacesuits found to rescue'
              .[
                this.ship.knownname, 
                this.ship.idcode, 
                this.ship, 
                this.ship.sector.knownname, 
              ]" output="true" append="true" /> 
          <resume label="start" />
        </do_if>
        <do_else>
          <debug_to_file directory="'rescuerangers'" name="'debug_' + this.ship.knownname + '_' + this.ship.idcode + '_' + this.ship"
            text="'[%s (%s - %s) at %s]  -  Found spacesuit to rescue: %s (%s - %s) at %s, will be rescued by: %s'
              .[
                this.ship.knownname, 
                this.ship.idcode, 
                this.ship, 
                this.ship.sector.knownname, 
                @$target.knownname,
                @$target.idcode,
                @$target,
                @$target.sector.knownname,
                @$target.pilot.$toRescueBy
              ]" output="true" append="true" />
          <set_value name="$crewFreeCount" exact="this.ship.people.free" />
          <create_order id="'RescueShip'" object="this.ship" immediate="true">
            <param name="target" value="$target"/>
            <!-- <param name="internalorder" value="true"/> -->
            <param name="debugchance" value="$debugChance"/>
          </create_order>
        </do_else>
      </do_if>
      <do_else>
        <wait min="1s" max="2s"/>
      </do_else>
      <resume label="findSpacesuits" />

      <label name="transferPeople" />
      
      <debug_to_file directory="'rescuerangers'" name="'debug_' + this.ship.knownname + '_' + this.ship.idcode + '_' + this.ship"
          text="'[%s (%s - %s) at %s]  -  This ship people: %s'
            .[
              this.ship.knownname, 
              this.ship.idcode, 
              this.ship, 
              this.ship.sector.knownname, 
              this.ship.people
            ]" output="true" append="true" />      

      <do_if value="this.ship.people.free">
        <resume label="findSpacesuits" />
      </do_if>
      
      <do_if value="this.ship.people.unassigned.count" >
        <debug_to_file directory="'rescuerangers'" name="'debug_' + this.ship.knownname + '_' + this.ship.idcode + '_' + this.ship"
          text="'[%s (%s - %s) at %s]  -  This ship rescued people: %s'
            .[
              this.ship.knownname, 
              this.ship.idcode, 
              this.ship, 
              this.ship.sector.knownname, 
              this.ship.people.unassigned.count
            ]" output="true" append="true" />      

        <do_if value="$shipDormitory != null and $shipDormitory.isoperational and $shipDormitory.people.free">
          <debug_to_file directory="'rescuerangers'" name="'debug_' + this.ship.knownname + '_' + this.ship.idcode + '_' + this.ship"
            text="'[%s (%s - %s) at %s]  -  Ready to transfer rescued people to dormitory: %s (%s - %s) at %s'
              .[
                this.ship.knownname, 
                this.ship.idcode, 
                this.ship, 
                this.ship.sector.knownname, 
                $shipDormitory.knownname,
                $shipDormitory.idcode,
                $shipDormitory,
                $shipDormitory.sector.knownname,
              ]" output="true" append="true" /> 
          <set_value name="$peopleToTransfer" exact="[this.ship.people.unassigned.count, $shipDormitory.people.free].min" />
          <transfer_people result="$peopleTransferred" object="$target" otherobject="this.ship" receiveworkforce="false" receivepeople="true" >
            <matching_people currentroles="[entityrole.unassigned]" amounts="[$peopleToTransfer]"/>
          </transfer_people>
          <do_if value="@$peopleTransferred">
            <debug_to_file directory="'rescuerangers'" name="'debug_' + this.ship.knownname + '_' + this.ship.idcode + '_' + this.ship"
              text="'[%s (%s - %s) at %s]  -  Transferred %s people to dormitory: %s (%s - %s) at %s'
                .[
                  this.ship.knownname, 
                  this.ship.idcode, 
                  this.ship, 
                  this.ship.sector.knownname, 
                  $peopleTransferred,
                  $shipDormitory.knownname,
                  $shipDormitory.idcode,
                  $shipDormitory,
                  $shipDormitory.sector.knownname,
                ]" output="true" append="true" />
            </do_if>  
        </do_if>
        <do_if value="this.ship.people.free and $shipDormitory.people.free" negate="true">
          <debug_to_file directory="'rescuerangers'" name="'debug_' + this.ship.knownname + '_' + this.ship.idcode + '_' + this.ship"
            text="'[%s (%s - %s) at %s]  -  No space left to rescue people, on this ship (%s) and on dormitory (%s). '
              .[
                this.ship.knownname, 
                this.ship.idcode, 
                this.ship, 
                this.ship.sector.knownname, 
                this.ship.people.free,
                $shipDormitory.people.free,
              ]" output="true" append="true" />
          <set_value name="$canRescue" exact="false" />
          <set_value name="$speakline" exact="10304" comment="Awaiting orders." />
          <run_script name="'player.interaction'">
            <param name="Line" value="$speakline" />
            <param name="MaxQueueDelay" value="10s" />
            <param name="caption" value="{1016, 6}.[this.assignedcontrolled.knownname, this.assignedcontrolled.idcode]" />
            <param name="interactive" value="false" />
          </run_script>
          <resume label="start" />
        </do_if>
      </do_if>

      <label name="finish" />
    </actions>
  </attention>
</aiscript>