<?xml version="1.0" encoding="iso-8859-1"?>
<aiscript name="order.rescue.rangers.sector" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="aiscripts.xsd" version="101" priority="1">
  <order id="RescueRangers" name="{1972092402, 1}" description="{1972092402, 2}" category="navigation" infinite="true">
    <params>
      <param name="homeSector" default="if @this.ship.commanderentity.$config_subordinate_range then @this.ship.commanderentity.$config_subordinate_range
            else (if @this.ship.commander.jobmainsector then this.ship.commander.jobmainsector
              else (if @this.ship.commander.isclass.[class.station, class.buildstorage] then this.ship.commander.sector
                else (if this.ship.jobmainsector then this.ship.jobmainsector
                  else this.sector)))" type="sector" required="true" text="{1972092402, 101}" />
      <param name="maxDistanceAround" default="0" type="number" text="{1972092402, 104}" comment="Max gate distance from Home sector to rescue">
        <input_param name="startvalue" value="0"/>
        <input_param name="min" value="0"/>
        <input_param name="max" value="if @this.ship.pilot.skill.piloting lt 6 then 0 else if @this.ship.pilot.skill.piloting lt 9 then 1 else if @this.ship.pilot.skill.piloting lt 12 then 2 else 3"/>
        <input_param name="step" value="1"/>
      </param>
      <param name="homeStation" type="object"  text="{1972092402, 102}" >
        <input_param name="class" value="[class.station]"/>
      </param>
      <param name="shipDormitory" type="object"  text="{1972092402, 103}">
        <input_param name="class" value="[class.ship]"/>
        <input_param name="owner" value="this.ship.trueowner"/>
      </param>
      <param name="rescuePriorityByOxygenRemained" type="bool" default="false" text="{1972092402, 105}" />
      <param name="recordActionsToLogBook" type="bool" default="true" text="{1972092402, 109}" />
      <param name="isStartedByPlayer" type="internal" default="true" text="Started by Player"></param>
      <param name="debugchance" type="bool" default="0" advanced="true" text="{1041, 10086}" comment="Print debug output">
        <input_param name="truevalue" value="100"/>
        <editable/>
      </param>
    </params>
    <skill min="20" />
    <requires>
      <match shiptype="shiptype.lasertower" negate="true" />
      <match class="class.spacesuit" negate="true"/>
    </requires>
    <location object="$homeSector" condition="$homeSector.zone.exists" />
  </order>

  <interrupts>
    <handler ref="AttackHandler" />
    <handler ref="MissileLockHandler" />
    <handler ref="ScannedHandler" />
    <handler ref="InspectedHandler" />
    <handler ref="FoundAbandonedHandler" />
    <handler ref="FoundLockboxHandler" />
    <handler ref="ResupplyHandler" />
    <handler>
      <conditions>
        <check_all>
          <event_game_loaded />
          <debug_text text="'%s [%s at %s] - Game loaded with version %s'.
          [
            player.age,
            this.assignedcontrolled.debugname,
            this.assignedcontrolled.sector.knownname,
            @$scriptVersion,
          ]" debugchance="100"/>
          <check_any>
            <check_value value="@$scriptVersion lt 101" />
          </check_any>
        </check_all>
      </conditions>
      <actions>
        <debug_to_file directory="'rescuerangers'" name="'debug_' + this.assignedcontrolled.idcode + '_' + this.assignedcontrolled"
          text="'[%s at %s] - Re-init for versions prior to 1.01. Home sector: %s, home station: %s, dormitory: %s, recordActionsToLogBook: %s'
          .[
            this.assignedcontrolled.debugname,
            this.assignedcontrolled.sector.knownname,
            @$homeSector.knownname,
            @$homeStation.knownname,
            @$shipDormitory.knownname,
            @$recordActionsToLogBook,
          ]" output="true" append="true" />
        <do_if value="@$scriptVersion lt 101">
          <cancel_all_orders object="this.assignedcontrolled" />
          <create_order object="this.assignedcontrolled" id="'RescueRangers'" default="true">
            <param name="homeSector" value="@$homeSector" />
            <param name="maxDistanceAround" value="0" />
            <param name="homeStation" value="@$homeStation" />
            <param name="shipDormitory" value="@$shipDormitory" />
            <param name="rescuePriorityByOxygenRemained" value="false" />
            <param name="recordActionsToLogBook" value="@$recordActionsToLogBook" />
            <param name="isStartedByPlayer" value="false" />
          </create_order>
        </do_if>
      </actions>
    </handler>
    <handler>
      <conditions>
        <check_all>
          <event_player_owned_destroyed/>
          <check_value value="event.param.isclass.ship" />
          <check_value value="@event.param.type == shiptype.lasertower" negate="true"/>
          <check_value value="event.param != this.assignedcontrolled" />
          <check_any>
            <check_value value="event.param.sector == $homeSector" />
            <check_value value="$sectorsList.indexof.{@event.param.sector} gt 0" />
          </check_any>
          <check_any>
            <check_all>
              <check_value value="$target == null"/>
              <check_value value="event.param.isclass.spacesuit" negate="true"/>
              <check_value value="$shipTypesToExclude.indexof.{@event.param.type} le 0" />
              <check_value value="this.assignedcontrolled.people.free gt 0" />
            </check_all>
            <check_all>
              <check_value value="event.param == $target" />
              <check_value value="event.param.isclass.spacesuit" />
            </check_all>
          </check_any>
        </check_all>
      </conditions>
      <actions>
        <debug_to_file directory="'rescuerangers'" name="'debug_' + this.assignedcontrolled.idcode + '_' + this.assignedcontrolled"
          text="'[%s at %s] - %s, our : %s (class: %s, type: %s - %s) in sector: %s. Killer: %s {%s}, method: %s. Spacesuit docked: %s. Crew free: %s'
            .[
              this.assignedcontrolled.debugname,
              this.assignedcontrolled.sector.knownname,
              @event.name,
              @event.param.debugname,
              @event.param.class,
              @event.param.type,
              @event.param.typename,
              @event.param.sector.knownname,
              @event.param2.debugname,
              @event.param2.class,
              @event.param3,
              event.param == $target,
              this.assignedcontrolled.people.free,
            ]"
          output="true" append="true" />
        <do_if value="$target != null">
          <do_if value="$target.pilot.$toRescueBy?">
            <remove_value name="$target.pilot.$toRescueBy" />
          </do_if>
          <set_value name="$target" exact="null" />
          <do_if value="@event.param3 == killmethod.removed">
            <do_if value="$recordActionsToLogBook">
              <write_to_logbook category="general" title="$textTitle" text="{1972092402, 1032}.[$textUnit, $textTargetPerson, $textTargetSector]" interaction="showonmap" object="this.assignedcontrolled" />
            </do_if>
            <apply_experience entity="this" experience="'rescue_rangers'" chance="90"/>
          </do_if>
        </do_if>
        <do_else>
          <apply_experience entity="this" experience="'rescue_rangers'" chance="45"/>
        </do_else>
        <do_if value="this.assignedcontrolled.people.free gt 0">
          <debug_to_file directory="'rescuerangers'" name="'debug_' + this.assignedcontrolled.idcode + '_' + this.assignedcontrolled"
            text="'[%s at %s] - Going to search spacesuits. Crew free: %s'
              .[
                this.assignedcontrolled.debugname,
                this.assignedcontrolled.sector.knownname,
                this.assignedcontrolled.people.free,
              ]"
            output="true" append="true" />
          <!-- $targetSector is used to store the sector where our ship was destroyed, to limit search of spacesuits -->
          <set_value name="$targetSector" exact="@event.param.sector" />
          <abort_called_scripts resume="findSpacesuits" />
        </do_if>
        <do_else>
          <debug_to_file directory="'rescuerangers'" name="'debug_' + this.assignedcontrolled.idcode + '_' + this.assignedcontrolled"
            text="'[%s at %s] - Going to transfer persons. Crew free: %s'
              .[
                this.assignedcontrolled.debugname,
                this.assignedcontrolled.sector.knownname,
                this.assignedcontrolled.people.free,
              ]"
            output="true" append="true" />
          <abort_called_scripts resume="transferPeople" />
        </do_else>
      </actions>
    </handler>
    <handler>
      <conditions>
        <check_all>
          <event_object_docked_at container="this.assignedcontrolled"/>
          <check_value value="$target != null" />
          <check_value value="event.param == $target" />
        </check_all>
      </conditions>
      <actions>
        <debug_to_file directory="'rescuerangers'" name="'debug_' + this.assignedcontrolled.idcode + '_' + this.assignedcontrolled"
          text="'[%s at %s] - %s, our : %s {%s} in sector: %s, docked at: %s. Free before: %s, after: %s.'
            .[
              this.assignedcontrolled.debugname,
              this.assignedcontrolled.sector.knownname,
              event.name,
              event.param.debugname,
              event.param.class,
              event.param.sector.knownname,
              event.param.dock,
              $crewFreeCount,
              this.assignedcontrolled.people.free,
            ]"
          output="true" append="true" />
        <do_if value="$target.pilot.$toRescueBy?">
          <remove_value name="$target.pilot.$toRescueBy" />
        </do_if>
        <set_value name="$target" exact="null" />
        <do_if value="this.assignedcontrolled.people.free lt $crewFreeCount">
          <apply_experience entity="this" experience="'rescue_rangers'" chance="90"/>
          <do_if value="$recordActionsToLogBook">
            <write_to_logbook category="general" title="$textTitle" text="{1972092402, 1032}.[$textUnit, $textTargetPerson, $textTargetSector]" interaction="showonmap" object="this.assignedcontrolled" />
          </do_if>
        </do_if>
        <do_if value="this.assignedcontrolled.people.free gt 0">
          <abort_called_scripts resume="findSpacesuits" />
        </do_if>
        <do_else>
          <abort_called_scripts resume="transferPeople" />
        </do_else>
      </actions>
    </handler>
   <handler>
      <conditions>
        <check_all>
          <check_any>
            <event_object_target_invalid object="this.assignedcontrolled" />
          </check_any>
          <check_value value="$target != null" />
        </check_all>
      </conditions>
      <actions>
        <debug_to_file directory="'rescuerangers'" name="'debug_' + this.assignedcontrolled.idcode + '_' + this.assignedcontrolled"
          text="'[%s at %s] - Event %s : %s {%s} status: iswreck: %s, isoperational: %s,  pilot: %s (%s), param: %s {%s}, , param2: %s {%s}, target: %s'
            .[
              this.assignedcontrolled.debugname,
              this.assignedcontrolled.sector.knownname,
              event.name,
              @event.object.debugname,
              @event.object.class,
              @event.object.iswreck,
              @event.object.isoperational,
              @event.object.pilot,
              event.object.pilot?,
              @event.param.debugname,
              @event.param.class,
              @event.param2.debugname,
              @event.param2.class,
              $target,
            ]" output="true" append="true" />
        <do_if value="$target != null">
          <do_if value="$target.pilot.$toRescueBy?">
            <remove_value name="$target.pilot.$toRescueBy" />
          </do_if>
          <set_value name="$target" exact="null" />
          <do_if value="this.assignedcontrolled.people.free gt 0">
            <abort_called_scripts resume="findSpacesuits" />
          </do_if>
          <do_else>
            <abort_called_scripts resume="transferPeople" />
          </do_else>
        </do_if>
        </actions>
    </handler>

  </interrupts>
  <init>
    <set_value name="$do_reset" exact="0" />
    <set_value name="$scriptVersion" exact="101" />

    <set_value name="$target" exact="null" />

    <do_if value="this.assignedcontrolled.pilot.$rescueData?">
      <do_if value="@this.assignedcontrolled.pilot.$rescueData.$timeStamp ge (player.age - 300)">
        <set_value name="$target" exact="@this.assignedcontrolled.pilot.$rescueData.$target" />
        <set_value name="$textTargetPerson" exact="@this.assignedcontrolled.pilot.$rescueData.$textTargetPerson" />
        <set_value name="$textTargetSector" exact="@this.assignedcontrolled.pilot.$rescueData.$textTargetSector" />
        <set_value name="$skipGoToDock" exact="true" />
        <set_value name="$crewFreeCount" exact="@this.assignedcontrolled.pilot.$rescueData.$crewFreeCount" />
        <debug_to_file directory="'rescuerangers'" name="'debug_' + this.assignedcontrolled.idcode + '_' + this.assignedcontrolled"
          text="'[%s at %s] - Found saved: target: %s, text: %s, at %s, skipGoToDock: %s, crewFreeCount: %s, free: %s'
            .[
              this.assignedcontrolled.debugname,
              this.assignedcontrolled.sector.knownname,
              $target.debugname,
              $textTargetPerson,
              $textTargetSector,
              $skipGoToDock,
              $crewFreeCount,
              this.assignedcontrolled.people.free,
            ]"
          output="true" append="true" />
      </do_if>
      <remove_value name="this.assignedcontrolled.pilot.$rescueData" />
    </do_if>
    <do_else>
      <set_value name="$skipGoToDock" exact="false" />
      <set_value name="$textTargetPerson" exact="''" />
      <set_value name="$textTargetSector" exact="''" />
    </do_else>

    <set_value name="$debugChance" exact="100" />

    <do_if value="$homeSector.isclass.sector" negate="true">
      <set_value name="$homeSector" exact="$homeSector.sector" />
    </do_if>

    <set_value name="$textTitle" exact="{1972092402, 1000}" />
    <set_value name="$textHomeSector" exact="{1972092402, 1003}.[$homeSector.knownname]" />
    <set_value name="$textHomeStation" exact="{1972092402, 1011}.[$homeStation.name, $homeStation.idcode]" />
    <set_value name="$textUnit" exact="{1972092402, 1011}.[this.assignedcontrolled.name, this.assignedcontrolled.idcode]" />
    <set_value name="$textDormitory" exact="{1972092402, 1011}.[$shipDormitory.name, $shipDormitory.idcode]" />

    <do_if value="$sectorsList?" negate="true">
      <create_list name="$sectorsList" />
    </do_if>
    <do_if value="$sectorsList.indexof.{$homeSector} gt 0" negate="true">
      <append_to_list name="$sectorsList" exact="$homeSector"/>
    </do_if>

    <!-- <set_command_action commandaction="commandaction.scanningto" param="$homeLocation.sector" /> -->

    <set_value name="$skipDockingMessageAfterScriptUpdate" exact="not $isStartedByPlayer"/>

    <debug_to_file directory="'rescuerangers'" name="'debug_' + this.assignedcontrolled.idcode + '_' + this.assignedcontrolled"
      text="'[%s at %s] - Free: %s. Started (by player: %s) version %s. \nSector: %s. Distance: %s. \nStation: [%s at %s]. Dormitory: [%s at %s], free: %s. \nSort by oxygen: %s. \nRecord to logbook: %s. \nDebug chance: %s. \nDock: [%s at %s], parked at: [%s at %s], has context: %s. Skip docking message: %s'
        .[
          this.assignedcontrolled.debugname,
          this.assignedcontrolled.sector.knownname,
          this.assignedcontrolled.people.free,
          $isStartedByPlayer,
          @$scriptVersion,
          @$homeSector.knownname,
          @$maxDistanceAround,
          @$homeStation.debugname,
          @$homeStation.sector.knownname,
          @$shipDormitory.debugname,
          @$shipDormitory.sector.knownname,
          @$shipDormitory.people.free,
          @$sectorsList,
          @$rescuePriorityByOxygenRemained,
          @$recordActionsToLogBook,
          $debugchance,
          @this.assignedcontrolled.dock.container.debugname,
          @this.assignedcontrolled.dock.container.sector.knownname,
          @this.assignedcontrolled.parkedat.debugname,
          @this.assignedcontrolled.parkedat.sector.knownname,
          @this.assignedcontrolled.parkedat.hascontext.{$homeStation},
          $skipDockingMessageAfterScriptUpdate,
        ]" output="true" append="true" />


    <set_value name="$crewFreeCount" exact="this.assignedcontrolled.people.free" />

    <do_if value="$isStartedByPlayer and not $skipGoToDock">
      <write_to_logbook category="general" title="$textTitle" text="{1972092402, 1021}.[$textUnit, $textHomeSector]" interaction="showonmap" object="this.assignedcontrolled" />
    </do_if>

    <set_value name="$shipTypesToExclude" exact="[shiptype.xsdrone, shiptype.distressdrone, shiptype.smalldrone, shiptype.personalvehicle, shiptype.escapepod]"/>

    <!-- $targetSector is used to store the sector where our ship was destroyed, to limit search of spacesuits -->
    <set_value name="$targetSector" exact="null" />

    <set_value name="$isStartedByPlayer" exact="false" />

  </init>

  <attention min="unknown">
    <actions>

      <label name="postInit" />

      <run_script name="'lib.find.sectors.inrange'" result="$sectorsList" sinceversion="5">
        <param name="refobject" value="$homeSector"/>
        <param name="mingatedistance" value="0"/>
        <param name="maxgatedistance" value="$maxDistanceAround"/>
        <param name="debugchance" value="$debugChance"/>
      </run_script>

      <do_if value="$sectorsList?" negate="true">
        <create_list name="$sectorsList" />
      </do_if>
      <do_if value="$sectorsList.indexof.{$homeSector} gt 0" negate="true">
        <append_to_list name="$sectorsList" exact="$homeSector"/>
      </do_if>

      <debug_to_file directory="'rescuerangers'" name="'debug_' + this.assignedcontrolled.idcode + '_' + this.assignedcontrolled"
        text="'[%s at %s] - Post init version %s. Sector: %s. Distance: %s. Sectors: %s.'
          .[
            this.assignedcontrolled.debugname,
            this.assignedcontrolled.sector.knownname,
            @$scriptVersion,
            @$homeSector.knownname,
            @$maxDistanceAround,
            $sectorsList,
          ]" output="true" append="true" />

      <label name="start" />

      <debug_to_file directory="'rescuerangers'" name="'debug_' + this.assignedcontrolled.idcode + '_' + this.assignedcontrolled"
          text="'[%s at %s] - This ship: free: %s, unassigned: %s. Dormitory ship: free: %s, unassigned: %s. HomeStation: %s at %s. Target: %s, crewFreeCount: %s, skipGoToDock: %s'
            .[
              this.assignedcontrolled.debugname,
              this.assignedcontrolled.sector.knownname,
              this.assignedcontrolled.people.free,
              @this.assignedcontrolled.people.{entityrole.unassigned}.count,
              @$shipDormitory.people.free,
              @$shipDormitory.people.{entityrole.unassigned}.count,
              @$homeStation.debugname,
              @$homeStation.sector.knownname,
              $target,
              $crewFreeCount,
              $skipGoToDock,
            ]" output="true" append="true" />


      <do_if value="this.assignedcontrolled.order" comment="Safety check in case the script is called from non-order script">
        <!-- Required for all infinite orders, no effect in case of finite timeout -->
        <set_order_syncpoint_reached order="this.assignedcontrolled.order" />
      </do_if>

      <do_if value="$skipGoToDock or (this.assignedcontrolled.dock and (this.assignedcontrolled.dock.container == $homeStation)) or (this.assignedcontrolled.parkedat and ((this.assignedcontrolled.parkedat == $homeStation) or this.assignedcontrolled.parkedat.hascontext.{$homeStation}))">
        <do_if value="$target != null">
          <debug_to_file directory="'rescuerangers'" name="'debug_' + this.assignedcontrolled.idcode + '_' + this.assignedcontrolled"
            text="'[%s at %s] - Previously saved person: %s at %s. Crew free: %s, previous free: %s. Wait for event 3s.'
              .[
                this.assignedcontrolled.debugname,
                this.assignedcontrolled.sector.knownname,
                $textTargetPerson,
                $textTargetSector,
                this.assignedcontrolled.people.free,
                $crewFreeCount,
              ]"
            output="true" append="true" />
          <wait exact="3s"/>
          <do_if value="$crewFreeCount gt @this.assignedcontrolled.people.free">
            <set_value name="$target" exact="null" />
            <do_if value="$recordActionsToLogBook">
              <set_value name="$textSector" exact="{1972092402, 1003}.[$homeSector.knownname]" />
              <write_to_logbook category="general" title="$textTitle" text="{1972092402, 1032}.[$textUnit, $textTargetPerson, $textTargetSector]" interaction="showonmap" object="this.assignedcontrolled" />
            </do_if>
            <apply_experience entity="this" experience="'rescue_rangers'" chance="90"/>
          </do_if>
          <set_value name="$target" exact="null" />
          <do_if value="this.assignedcontrolled.people.free gt 0">
            <debug_to_file directory="'rescuerangers'" name="'debug_' + this.assignedcontrolled.idcode + '_' + this.assignedcontrolled"
              text="'[%s at %s] - Going to search spacesuits. Crew free: %s'
                .[
                  this.assignedcontrolled.debugname,
                  this.assignedcontrolled.sector.knownname,
                  this.assignedcontrolled.people.free,
                ]"
              output="true" append="true" />
            <resume label="findSpacesuits" />
          </do_if>
          <do_else>
            <debug_to_file directory="'rescuerangers'" name="'debug_' + this.assignedcontrolled.idcode + '_' + this.assignedcontrolled"
              text="'[%s at %s] - Going to transfer persons. Crew free: %s'
                .[
                  this.assignedcontrolled.debugname,
                  this.assignedcontrolled.sector.knownname,
                  this.assignedcontrolled.people.free,
                ]"
              output="true" append="true" />
            <resume label="transferPeople" />
          </do_else>
        </do_if>
        <wait min="150s" max="370s" />
        <do_if value="@this.assignedcontrolled.people.{entityrole.unassigned}.count gt 0">
          <resume label="transferPeople" />
        </do_if>
      </do_if>
      <do_else>
        <debug_to_file directory="'rescuerangers'" name="'debug_' + this.assignedcontrolled.idcode + '_' + this.assignedcontrolled"
          text="'[%s at %s] - going to dock at homeStation: %s at %s'
            .[
              this.assignedcontrolled.debugname,
              this.assignedcontrolled.sector.knownname,
              @$homeStation.debugname,
              @$homeStation.sector.knownname,
            ]" output="true" append="true" />
        <do_if value="$skipDockingMessageAfterScriptUpdate" negate="true">
          <do_if value="$recordActionsToLogBook">
            <write_to_logbook category="general" title="$textTitle" text="{1972092402, 1022}.[$textUnit, $textHomeStation]" interaction="showonmap" object="this.assignedcontrolled" />
          </do_if>
        </do_if>
        <do_else>
          <set_value name="$skipDockingMessageAfterScriptUpdate" exact="false"/>
        </do_else>
        <run_script name="'order.dock'" result="$docked">
          <param name="destination" value="$homeStation"/>
          <!-- <param name="abouttofinish" value="true"/> -->
          <param name="debugchance" value="$debugChance"/>
        </run_script>
        <debug_to_file directory="'rescuerangers'" name="'debug_' + this.assignedcontrolled.idcode + '_' + this.assignedcontrolled"
          text="'[%s at %s] - Result: %s'
            .[
              this.assignedcontrolled.debugname,
              this.assignedcontrolled.sector.knownname,
              @$docked,
            ]" output="true" append="true" />
      </do_else>

      <resume label="start" />

      <label name="findSpacesuits" />

      <set_value name="$skipGoToDock" exact="false" />

      <do_if value="$target == null">

        <do_if value="$sectorsList.count gt 1">
          <do_if value="$targetSector != null">
            <!-- in case of destroying our ship we will start search only in sector where it happens -->
            <set_value name="$whereToFind" exact="$targetSector"/>
          </do_if>
          <do_else>
           <!-- otherwise we will start search in current sector of rescuer ship -->
            <set_value name="$whereToFind" exact="this.assignedcontrolled.sector"/>
          </do_else>
        </do_if>
        <do_else>
          <!-- there is no multiple sectors is configured -->
          <set_value name="$whereToFind" exact="$homeSector"/>
        </do_else>

        <find_ship name="$spacesuits" space="$whereToFind" class="class.spacesuit" docked="false" checkoperational="true"  recursive="true" multiple="true" sortbydistanceto="this.assignedcontrolled">
          <match trueowner="faction.player"/>
        </find_ship>

        <!-- If noting found in one sector - will try to do it in all of them-->
        <do_if value="@$spacesuits.count == 0 and $sectorsList.count gt 1">
          <debug_to_file directory="'rescuerangers'" name="'debug_' + this.assignedcontrolled.idcode + '_' + this.assignedcontrolled"
            text="'[%s at %s] - No spacesuits found to rescue in selected one sector %s. Going to search in other sectors'
              .[
                this.assignedcontrolled.debugname,
                this.assignedcontrolled.sector.knownname,
                $whereToFind.knownname,
              ]" output="true" append="true" />
          <resume label="start" />
          <find_ship name="$spacesuits" space="$sectorsList" class="class.spacesuit" docked="false" checkoperational="true"  recursive="true" multiple="true" sortbydistanceto="this.assignedcontrolled">
            <match trueowner="faction.player"/>
          </find_ship>
        </do_if>

        <!-- Clear $targetSector for future interactions -->
        <set_value name="$targetSector" exact="null" />

        <do_if value="@$rescuePriorityByOxygenRemained">
          <sort_list list="$spacesuits" sortbyvalue="loop.element.oxygentimeremaining" sortdescending="false" />
        </do_if>

        <debug_to_file directory="'rescuerangers'" name="'debug_' + this.assignedcontrolled.idcode + '_' + this.assignedcontrolled"
          text="'[%s at %s] - Spacesuits: found: %s, list: %s. Sectors: primary %s, list: %s'
            .[
              this.assignedcontrolled.debugname,
              this.assignedcontrolled.sector.knownname,
              @$spacesuits.count,
              @$spacesuits,
              $whereToFind,
              @$sectorsList,
            ]" output="true" append="true" />

        <set_value name="$spacesuitsIndex" exact="1" />

        <do_while value="$target == null and $spacesuitsIndex le $spacesuits.count">
          <set_value name="$target" exact="$spacesuits.{$spacesuitsIndex}" />

          <do_if value="($target.assigneddock and $target.assigneddock.controllable != this.assignedcontrolled) or (@$target.order.id == 'DockAt' and $target.order.$destination != this.assignedcontrolled)">
            <do_if value="$target.assigneddock and $target.assigneddock.controllable != this.assignedcontrolled">
              <set_value name="$targetAssignedToDock" exact="$target.assigneddock.controllable" />
            </do_if>
            <do_else>
              <set_value name="$targetAssignedToDock" exact="$target.order.$destination" />
            </do_else>
            <debug_to_file directory="'rescuerangers'" name="'debug_' + this.assignedcontrolled.idcode + '_' + this.assignedcontrolled"
              text="'[%s at %s] - Target %s is already assigned to dock at %s'
                .[
                  this.assignedcontrolled.debugname,
                  this.assignedcontrolled.sector.knownname,
                  $target.debugname,
                  $targetAssignedToDock.debugname,
                ]" output="true" append="true" />
            <set_value name="$target" exact="null" />
          </do_if>
          <do_else>
            <do_if value="$target.pilot.$toRescueBy? and $target.pilot.$toRescueBy.$timestamp? and @$target.pilot.$toRescueBy.$timestamp - player.age le 300" negate="true">
              <set_value name="$target.pilot.$toRescueBy" exact="table[$timestamp = player.age, $id=$target.idcode]" />
            </do_if>
            <do_else>
              <debug_to_file directory="'rescuerangers'" name="'debug_' + this.assignedcontrolled.idcode + '_' + this.assignedcontrolled"
                text="'[%s at %s] - Person to rescue: %s, spacesuit: %s at %s, already marked to be rescued: %s'
                  .[
                    this.assignedcontrolled.debugname,
                    this.assignedcontrolled.sector.knownname,
                    @$target.pilot.knownname,
                    @$target.debugname,
                    @target.sector.knownname,
                    @$target.pilot.$toRescueBy,
                  ]" output="true" append="true" />
              <set_value name="$target" exact="null" />
            </do_else>
          </do_else>
          <set_value name="$spacesuitsIndex" exact="$spacesuitsIndex + 1" />
        </do_while>

        <do_if value="$target == null">
          <debug_to_file directory="'rescuerangers'" name="'debug_' + this.assignedcontrolled.idcode + '_' + this.assignedcontrolled"
            text="'[%s at %s] - No spacesuits found to rescue'
              .[
                this.assignedcontrolled.debugname,
                this.assignedcontrolled.sector.knownname,
              ]" output="true" append="true" />
          <resume label="start" />
        </do_if>
        <do_else>
          <debug_to_file directory="'rescuerangers'" name="'debug_' + this.assignedcontrolled.idcode + '_' + this.assignedcontrolled"
            text="'[%s at %s] - Found person to rescue: %s, spacesuit: %s at %s, will be rescued by: %s'
              .[
                this.assignedcontrolled.debugname,
                this.assignedcontrolled.sector.knownname,
                @$target.pilot.knownname,
                @$target.debugname,
                @$target.sector.knownname,
                @$target.pilot.$toRescueBy,
              ]" output="true" append="true" />
          <set_value name="$crewFreeCount" exact="this.assignedcontrolled.people.free" />
          <set_value name="$textTargetPerson" exact="{1972092402, 1014}.[@$target.pilot.knownname, $target.name, $target.idcode]" />
          <set_value name="$textTargetSector" exact="{1972092402, 1003}.[$target.sector.knownname]" />
          <do_if value="$recordActionsToLogBook">
            <write_to_logbook category="general" title="$textTitle" text="{1972092402, 1031}.[$textUnit, $textTargetPerson, $textTargetSector]" interaction="showonmap" object="this.assignedcontrolled" />
          </do_if>
          <set_value name="this.assignedcontrolled.pilot.$rescueData" exact="table[
            $timeStamp = player.age,
            $target = $target,
            $textTargetPerson = $textTargetPerson,
            $textTargetSector = $textTargetSector,
            $crewFreeCount = $crewFreeCount,
          ]" />
          <create_order id="'RescueShip'" object="this.assignedcontrolled" immediate="true">
            <param name="target" value="$target"/>
            <!-- <param name="internalorder" value="true"/> -->
            <param name="debugchance" value="$debugChance"/>
          </create_order>
          <debug_to_file directory="'rescuerangers'" name="'debug_' + this.assignedcontrolled.idcode + '_' + this.assignedcontrolled"
            text="'[%s at %s] - After run script or order call: %s at %s. Dock: %s. Free crew: previous: %s, now: %s. No space left: %s. rescueData: %s'
              .[
                this.assignedcontrolled.debugname,
                this.assignedcontrolled.sector.knownname,
                @$target.debugname,
                @$target.sector.knownname,
                @$target.dock,
                @$crewFreeCount,
                this.assignedcontrolled.people.free,
                this.assignedcontrolled.people.free le 0,
                this.assignedcontrolled.pilot.$rescueData,
              ]" output="true" append="true" />
              <wait min="3s" max="5s"/>
        </do_else>
      </do_if>
      <do_else>
        <wait min="1s" max="2s"/>
      </do_else>

      <resume label="start" />

      <label name="transferPeople" />

      <set_value name="$skipGoToDock" exact="false" />

      <debug_to_file directory="'rescuerangers'" name="'debug_' + this.assignedcontrolled.idcode + '_' + this.assignedcontrolled"
          text="'[%s at %s] - This ship people: free: %s, total: %s, capacity: %s, service: %s, marine: %s, unassigned: %s'
            .[
              this.assignedcontrolled.debugname,
              this.assignedcontrolled.sector.knownname,
              this.assignedcontrolled.people.free,
              @this.assignedcontrolled.people.count,
              @this.assignedcontrolled.people.capacity,
              @this.assignedcontrolled.people.{entityrole.service}.count,
              @this.assignedcontrolled.people.{entityrole.marine}.count,
              @this.assignedcontrolled.people.{entityrole.unassigned}.count,
            ]" output="true" append="true" />

      <do_if value="this.assignedcontrolled.people.{entityrole.unassigned}.count gt 0" >
        <debug_to_file directory="'rescuerangers'" name="'debug_' + this.assignedcontrolled.idcode + '_' + this.assignedcontrolled"
          text="'[%s at %s] - This ship rescued people: %s, and plan to transfer them to dormitory: %s at %s, with free %s and unassigned: %s'
            .[
              this.assignedcontrolled.debugname,
              this.assignedcontrolled.sector.knownname,
              this.assignedcontrolled.people.{entityrole.unassigned}.count,
              $shipDormitory.debugname,
              $shipDormitory.sector.knownname,
              $shipDormitory.people.free,
              $shipDormitory.people.{entityrole.unassigned}.count,
            ]" output="true" append="true" />

        <do_if value="$shipDormitory != null and $shipDormitory.isoperational and $shipDormitory.people.free gt 0">

          <do_if value="$recordActionsToLogBook">
            <write_to_logbook category="general" title="$textTitle" text="{1972092402, 1041}.[$textUnit, $textDormitory]" interaction="showonmap" object="this.assignedcontrolled" />
          </do_if>

          <debug_to_file directory="'rescuerangers'" name="'debug_' + this.assignedcontrolled.idcode + '_' + this.assignedcontrolled"
            text="'[%s at %s] - Ready to transfer rescued people to dormitory: %s at %s, with unassigned: %s'
              .[
                this.assignedcontrolled.debugname,
                this.assignedcontrolled.sector.knownname,
                $shipDormitory.debugname,
                $shipDormitory.sector.knownname,
                $shipDormitory.people.{entityrole.unassigned}.count,
              ]" output="true" append="true" />
          <set_value name="$peopleToTransfer" exact="[this.assignedcontrolled.people.{entityrole.unassigned}.count, $shipDormitory.people.free].min" />
          <transfer_people result="$personsTransferred" object="$shipDormitory" otherobject="this.assignedcontrolled" receiveworkforce="false" >
            <matching_people currentroles="[entityrole.unassigned]" amounts="[$peopleToTransfer]"/>
          </transfer_people>
          <do_if value="@$personsTransferred.count gt 0">
            <debug_to_file directory="'rescuerangers'" name="'debug_' + this.assignedcontrolled.idcode + '_' + this.assignedcontrolled"
              text="'[%s at %s] - Transferred %s persons to dormitory: %s at %s. Now free: %s, unassigned: %s, on dormitory: free: %s, unassigned: %s'
                .[
                  this.assignedcontrolled.debugname,
                  this.assignedcontrolled.sector.knownname,
                  $personsTransferred.count,
                  $shipDormitory.debugname,
                  $shipDormitory.sector.knownname,
                  this.assignedcontrolled.people.free,
                  this.assignedcontrolled.people.{entityrole.unassigned}.count,
                  $shipDormitory.people.free,
                  $shipDormitory.people.{entityrole.unassigned}.count,
                ]" output="true" append="true" />
            <do_if value="$recordActionsToLogBook">
              <write_to_logbook category="general" title="$textTitle" text="{1972092402, 1042}.[$textUnit, $personsTransferred.count, $textDormitory]" interaction="showonmap" object="this.assignedcontrolled" />
            </do_if>
            <resume label="findSpacesuits" />
          </do_if>
        </do_if>
        <do_if value="this.assignedcontrolled.people.free le 0 and ($shipDormitory == null or not $shipDormitory.isoperational or $shipDormitory.people.free le 0)">
          <debug_to_file directory="'rescuerangers'" name="'debug_' + this.assignedcontrolled.idcode + '_' + this.assignedcontrolled"
            text="'[%s at %s] - No space left to rescue people, on this ship (%s) and on dormitory (%s). '
              .[
                this.assignedcontrolled.debugname,
                this.assignedcontrolled.sector.knownname,
                this.assignedcontrolled.people.free,
                @$shipDormitory.people.free,
              ]" output="true" append="true" />
          <do_if value="$recordActionsToLogBook">
            <write_to_logbook category="general" title="$textTitle" text="{1972092402, 1091}.[$textUnit, $textDormitory]" interaction="showonmap" object="this.assignedcontrolled" />
          </do_if>
          <set_value name="$speakline" exact="10304" comment="Awaiting orders." />
          <run_script name="'player.interaction'">
            <param name="Line" value="$speakline" />
            <param name="MaxQueueDelay" value="10s" />
            <param name="caption" value="{1016, 6}.[this.assignedcontrolled.knownname, this.assignedcontrolled.idcode]" />
            <param name="interactive" value="false" />
          </run_script>
        </do_if>
      </do_if>

      <resume label="start" />

      <debug_to_file directory="'rescuerangers'" name="'debug_' + this.assignedcontrolled.idcode + '_' + this.assignedcontrolled"
        text="'[%s at %s] - Point before finish. '
          .[
            this.assignedcontrolled.debugname,
            this.assignedcontrolled.sector.knownname,
          ]" output="true" append="true" />

      <label name="finish" />

      <debug_to_file directory="'rescuerangers'" name="'debug_' + this.assignedcontrolled.idcode + '_' + this.assignedcontrolled"
        text="'[%s at %s] - Point after  finish. '
          .[
            this.assignedcontrolled.debugname,
            this.assignedcontrolled.sector.knownname,
          ]" output="true" append="true" />

      <resume label="start" />
    </actions>
  </attention>
  <on_abort>
    <debug_to_file directory="'rescuerangers'" name="'debug_' + this.assignedcontrolled.idcode + '_' + this.assignedcontrolled"
      text="'[%s at %s] - Aborted. Order: %s, is running: %s. '
        .[
          this.assignedcontrolled.debugname,
          this.assignedcontrolled.sector.knownname,
          this.assignedcontrolled.order.id,
          this.assignedcontrolled.order.isrunning,
        ]" output="true" append="true" />
  </on_abort>
</aiscript>