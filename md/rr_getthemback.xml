<?xml version="1.0" encoding="utf-8" ?>
<mdscript name="RR_GetThemBack" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="md.xsd">
  <cues>
  <cue name="Init" version="2">
      <conditions>
        <event_cue_signalled cue="md.Setup.Start" />
      </conditions>
      <actions>
      </actions>
      <!-- <patch sinceversion="1">
        <reset_cue cue="AutoSave" />
      </patch>
      <patch sinceversion="2">
        <remove_value name="md.$Player_EarlyWarningSatellites"/>
      </patch> -->
      <cues>
        <cue name="CollectCrewInfoFromDestroyedShip" instantiate="true" namespace="this">
          <conditions>
            <event_player_owned_destroyed />
            <check_value value="event.param.isclass.defensible and not event.param.ismasstraffic and not event.param.isunit and not event.param.isdeployable and not event.param.isclass.ship_xs and not event.param.isclass.buildstorage" />
            <check_value value="event.param3 != killmethod.collected" />
            <check_value value="event.param3 != killmethod.removed" comment="spacesuit is removed"/>
          </conditions>
          <actions>
            <set_value name="$destroyedShip" exact="event.param"/>
            <set_value name="$destroyedShipCommander" exact="$destroyedShip.toplevelcommander" comment="store in case pilot is ejected which will also remove the commander information"/>
            <set_value name="$destroyTimestamp" exact="player.age"/>
            <set_value name="$destroyedAt" exact="destroyedShip.sector"/>
            <do_if value="@player.entity.$RRData" negate="true">
              <set_value name="player.entity.$RRData" exact="table[$index = [], $data = []"/>
            </do_if>
            <find_ship name="$spacesuits" space="$destroyedAt" class="class.spacesuit" docked="false" checkoperational="true"  recursive="true" multiple="true">
              <match trueowner="faction.player"/>
            </find_ship>
            <debug_text text="'RR_GetThemBack - Collect SpaceSuits: Destroyed %s (class: %s, macro: %s, type: %s - %s) at %s, timestamp: %s, top commander: %s'.
              [
                $destroyedShip,
                $destroyedShip.class,
                $destroyedShip.macro,
                $destroyedAt.type,
                $destroyedAt.typename,
                $destroyedAt,
                $destroyTimestamp,
                $destroyedShipCommander
              ]" />
            <do_for_each name="$spacesuit" in="$spacesuits">
              <debug_text text="'RR_GetThemBack - Collect SpaceSuits: item: %s, age %s, entity: %s '.[ $spacesuit, $spacesuit.age, $spacesuit.pilot.name]" chance="100"/>
              <set_value name="$dataItem" exact="table[$name = $spacesuit.pilot.name, $container = $spacesuit, $commander = $destroyedShipCommander, $state = 'spacesuit', $time = player.age]" />
              <debug_text text="'RR_GetThemBack - Data Item: %s'.[ $dataItem ]" chance="100" />
              <append_to_list name="player.entity.$RRData.$index" exact="$spacesuit.pilot.name" />
              <append_to_list name="player.entity.$RRData.$data" exact="$dataItem" />
            </do_for_each>
            <remove_value name="$dataItem" />
            <remove_value name="$spacesuit"/>
            <remove_value name="$spacesuits"/>
            <remove_value name="$destroyedShip" />
            <remove_value name="$destroyedShipCommander" />
            <remove_value name="$destroyTimestamp" />
            <remove_value name="$destroyedAt" />
          </actions>
        </cue>
      </cues>
    </cue>
  </cues>
</mdscript>