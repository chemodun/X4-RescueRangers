<?xml version="1.0" encoding="utf-8"?>
<mdscript name="RR_GetThemBack" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="md.xsd">
  <cues>
    <cue name="Init" version="105">
      <conditions>
        <event_cue_signalled cue="md.Setup.Start" />
      </conditions>
      <actions>
      </actions>
      <!-- <patch sinceversion="1">
        <reset_cue cue="AutoSave" />
      </patch>
      <patch sinceversion="2">
        <remove_value name="md.$Player_EarlyWarningSatellites"/>
      </patch> -->
      <cues>
        <cue name="CollectCrewInfoFromDestroyedShip" instantiate="true" namespace="this">
          <conditions>
            <event_player_owned_destroyed />
            <check_value
              value="event.param.isclass.defensible and not event.param.ismasstraffic and not event.param.isunit and not event.param.isdeployable and not event.param.isclass.ship_xs and not event.param.isclass.buildstorage" />
            <check_value value="event.param3 != killmethod.collected" />
            <check_value value="event.param3 != killmethod.removed" comment="spacesuit is removed" />
          </conditions>
          <actions>
            <set_value name="$destroyedShip" exact="event.param" />
            <set_value name="$destroyedShipCommander" exact="$destroyedShip.toplevelcommander"
              comment="store in case pilot is ejected which will also remove the commander information" />
            <set_value name="$destroyTimestamp" exact="player.age" />
            <set_value name="$destroyedAt" exact="$destroyedShip.sector" />
            <do_if value="player.entity.$RRData?" negate="true">
              <set_value name="player.entity.$RRData" exact="table[$index = [], $data = []]" />
            </do_if>
            <debug_text
              text="'RR_GetThemBack - Collect SpaceSuits: Destroyed %s (class: %s, macro: %s, type: %s - %s) at %s(%s), timestamp: %s, top commander: %s'.
              [
                $destroyedShip.debugname,
                $destroyedShip.class,
                $destroyedShip.macro,
                $destroyedShip.type,
                $destroyedShip.typename,
                $destroyedAt,
                $destroyedAt.knownname,
                $destroyTimestamp,
                $destroyedShipCommander.debugname
              ]" />
            <find_ship_by_true_owner name="$spacesuits" faction="faction.player" space="$destroyedAt" class="class.spacesuit" docked="false"
              checkoperational="true"
              multiple="true" />
            <do_for_each name="$spacesuit" in="$spacesuits">
              <debug_text
                text="'RR_GetThemBack - Collect SpaceSuits: item: %s, age %s, entity: %s '.[ $spacesuit, $spacesuit.age, $spacesuit.pilot.name]"
                chance="100" />
              <set_value name="$dataItem"
                exact="table[$name = $spacesuit.pilot.name, $group = $destroyedShip.idcode, $container = $spacesuit.idcode, $class = $destroyedShip.class , $macro = $destroyedShip.macro, $commander = $destroyedShipCommander.idcode, $state = 'spacesuit', $time = player.age, $updated = player.age]" />
              <debug_text text="'RR_GetThemBack - Data Item: %s'.[ $dataItem ]" chance="100" />
              <append_to_list name="player.entity.$RRData.$index" exact="$spacesuit.pilot.name" />
              <append_to_list name="player.entity.$RRData.$data" exact="$dataItem" />
            </do_for_each>
            <remove_value name="$dataItem" />
            <remove_value name="$spacesuit" />
            <remove_value name="$spacesuits" />
            <remove_value name="$destroyedShip" />
            <remove_value name="$destroyedShipCommander" />
            <remove_value name="$destroyTimestamp" />
            <remove_value name="$destroyedAt" />
          </actions>
        </cue>
        <library name="RecoveryCrewOnReplacementShip">
          <actions>
            <debug_text
              text="'RR_GetThemBack - RecoveryCrew: Data exists: %s. Records count: %s. Input: Replacement: %s. Commander: %s'.
              [
                player.entity.$RRData?,
                player.entity.$RRData.$index.count,
                $replacement.debugname,
                $commander.debugname
              ]"
              chance="100" />
            <do_if value="player.entity.$RRData? and @player.entity.$RRData.$index.count gt 0">
              <set_value name="$data" exact="player.entity.$RRData.$data" />
              <set_value name="$group" exact="''" />
              <create_list name="$replacementCrew" />
              <create_list name="$replacementCrewIndex" />
              <do_for_each name="$person" in="$data">
                <do_if
                  value="$person.$commander == $commander.idcode and $person.macro == $replacement.macro and ($group == '' or $group == $person.$group)">
                  <do_if value="$group == ''">
                    <set_value name="$group" exact="$person.$group" />
                  </do_if>
                  <set_value name="$group" exact="$person.$group" />
                  <append_to_list name="$replacementCrew" exact="$person" />
                  <append_to_list name="$replacementCrewIndex" exact="$person.$name" />
                  <debug_text text="'RR_GetThemBack - RecoveryCrew: Person added to replacement crew: %s'.[ $person ]" chance="100" />
                </do_if>
              </do_for_each>
              <debug_text text="'RR_GetThemBack - RecoveryCrew: Replacement crew count: %s'.[ $replacementCrew.count ]" chance="100" />
              <do_if value="@replacementCrew.count gt 0">
                <debug_text text="'RR_GetThemBack - RecoveryCrew: Replacement crew: %s'.[ $replacementCrew ]" chance="100" />
                <create_list name="$dormitories" />
                <create_list name="$dormitoriesEntities" />
                <create_list name="$dormitoriesIndex" />
                <create_list name="$dormitoriesClasses" />
                <create_list name="$pilots" />
                <create_list name="$engineers" />
                <create_list name="$marines" />
                <do_for_each name="$crewMember" in="$replacementCrew">
                  <debug_text text="'RR_GetThemBack - RecoveryCrew: Crew member: %s'.[ $crewMember ]" chance="100" />
                  <set_value name="$dormitoryIndex" exact="$dormitoriesIndex.indexof.{$crewMember.$container}" />
                  <do_if value="$dormitoryIndex le 0">
                    <append_to_list name="$dormitoriesIndex" exact="$crewMember.$container" />
                    <append_to_list name="$dormitoriesEntities" exact="[]" />
                    <append_to_list name="$dormitories" exact="null" />
                    <set_value name="$dormitoryIndex" exact="$dormitoriesIndex.count" />
                  </do_if>
                  <append_to_list name="$dormitories.{$dormitoryIndex}" exact="$crewMember" />
                  <do_if value="$dormitoriesClasses.indexof.{$crewMember.$class} le 0">
                    <append_to_list name="$dormitoriesClasses" exact="$crewMember.$class" />
                  </do_if>
                </do_for_each>
                <debug_text
                  text="'RR_GetThemBack - RecoveryCrew: Dormitories with possible crew members: %s. Classes: %s'.[ $dormitoriesIndex, $dormitoriesClasses ]"
                  chance="100" />
                <find_ship_by_true_owner faction="faction.player" name="$dormitories" space="player.galaxy" class="$dormitoriesClasses"
                  checkoperational="true"
                  multiple="true" />
                <do_for_each name="$dormitory" in="$dormitories">
                  <set_value name="$dormitoryIndex" exact="$dormitoriesIndex.indexof.{$dormitory.idcode}" />
                  <do_if value="$dormitoryIndex gt 0">
                    <set_value name="$dormitories.{$dormitoryIndex}" exact="$dormitory" />
                    <debug_text
                      text="'RR_GetThemBack - RecoveryCrew: Dormitory: %s, Entities count: %s'.[ $dormitory.idcode, $dormitoryEntities.{$dormitoryIndex}.count ]"
                      chance="100" />
                  </do_if>
                </do_for_each>
              </do_if>
            </do_if>
            <do_else>
              <debug_text text="'RR_GetThemBack - RecoveryCrew: No data for recovery'" chance="100" />
            </do_else>
            <remove_value name="$person" />
            <remove_value name="$crewMember" />
            <remove_value name="$dormitory" />
            <remove_value name="$dormitoryIndex" />
            <remove_value name="$dormitories" />
            <remove_value name="$dormitoriesEntities" />
            <remove_value name="$dormitoriesIndex" />
            <remove_value name="$dormitoriesClasses" />
            <remove_value name="$replacementCrew" />
            <remove_value name="$replacementCrewIndex" />
            <remove_value name="$data" />
            <remove_value name="$group" />
            <remove_value name="$replacementCrew" />
          </actions>
        </library>
      </cues>
    </cue>
  </cues>
</mdscript>