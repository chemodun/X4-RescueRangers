<?xml version="1.0" encoding="utf-8"?>
<mdscript name="RR_GetThemBack" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="md.xsd">
  <cues>
    <cue name="Init" version="105">
      <conditions>
        <event_cue_signalled cue="md.Setup.Start" />
      </conditions>
      <actions>
      </actions>
      <cues>

        <cue name="CollectCrewInfoFromDestroyedShip" instantiate="true" namespace="this">
          <conditions>
            <event_player_owned_destroyed />
            <check_value
              value="event.param.isclass.defensible and not event.param.ismasstraffic and not event.param.isunit and not event.param.isdeployable and not event.param.isclass.ship_xs and not event.param.isclass.buildstorage" />
            <check_value value="event.param3 != killmethod.collected" />
            <check_value value="event.param3 != killmethod.removed" comment="spacesuit is removed" />
          </conditions>
          <actions>
            <set_value name="$destroyedShip" exact="event.param" />
            <set_value name="$destroyTimestamp" exact="player.age" />
            <set_value name="$destroyedAt" exact="$destroyedShip.sector" />
            <include_actions ref="RRDataInit" />
            <debug_text
              text="'RR_GetThemBack - Collect SpaceSuits: Destroyed %s (class: %s, macro: %s, type: %s - %s) at %s(%s), timestamp: %s'.
              [
                $destroyedShip.debugname,
                $destroyedShip.class,
                $destroyedShip.macro,
                $destroyedShip.type,
                $destroyedShip.typename,
                $destroyedAt,
                $destroyedAt.knownname,
                $destroyTimestamp
              ]" />
            <find_ship_by_true_owner name="$spacesuits" faction="faction.player" space="$destroyedAt" class="class.spacesuit" docked="false"
              checkoperational="true"
              multiple="true" />
            <do_for_each name="$spacesuit" in="$spacesuits">
              <debug_text
                text="'RR_GetThemBack - Collect SpaceSuits: item: %s, age %s, entity: %s '.[ $spacesuit, $spacesuit.age, $spacesuit.pilot.name]"
                chance="100" />
              <do_if value="$spacesuit.age gt 1">
                <debug_text text="'RR_GetThemBack - Collect SpaceSuits: %s is too old to be collected'.[ $spacesuit.pilot.name ]"
                  chance="100" />
                <continue />
              </do_if>
              <set_value name="$dataItem"
                exact="table[
                  $name = $spacesuit.pilot.knownname,
                  $id = $spacesuit.pilot.npctemplate,
                  $container = null,
                  $containerId = $spacesuit.idcode,
                  $containerTag = 'spacesuit',
                  $containerType = $spacesuit.type,
                  $containerClass = class.spacesuit,
                  $macro = $destroyedShip.macro,
                  $shipId = @$destroyedShip.idcode,
                  $updated = player.age]" />
              <debug_text text="'RR_GetThemBack - Data Item: %s.'.[ $dataItem ]" chance="100" />
              <append_to_list name="player.entity.$RRData.$indexPre" exact="$spacesuit.pilot.name" />
              <append_to_list name="player.entity.$RRData.$dataPre" exact="$dataItem" />
            </do_for_each>
            <set_value name="$macroIndex" exact="player.entity.$RRData.$withoutCommandersIndex.indexof.{$destroyedShip.macro}" />
            <do_if value="$macroIndex le 0">
              <append_to_list name="player.entity.$RRData.$withoutCommanders"
                exact="[table[$id = $destroyedShip.idcode, $countMax = $spacesuits.count, $updated = player.age]]" />
              <append_to_list name="player.entity.$RRData.$withoutCommandersIndex" exact="$destroyedShip.macro" />
              <set_value name="$macroIndex" exact="1" />
            </do_if>
            <do_else>
              <append_to_list name="player.entity.$RRData.$withoutCommanders.{$macroIndex}"
                exact="table[$id = $destroyedShip.idcode, $countMax = $spacesuits.count, $updated = player.age]" />
            </do_else>
            <debug_text
              text="'RR_GetThemBack - Collect SpaceSuits: Without Commanders: Macro: %s. Data %s at %s'.
              [
                $destroyedShip.macro,
                player.entity.$RRData.$withoutCommanders.{$macroIndex},
                $macroIndex
              ]"
            />
            <remove_value name="$destroyedShip" />
            <remove_value name="$dataItem" />
            <remove_value name="$spacesuit" />
            <remove_value name="$spacesuits" />
            <remove_value name="$destroyedShip" />
            <remove_value name="$destroyTimestamp" />
            <remove_value name="$destroyedAt" />
          </actions>
        </cue>

        <library name="RRDataInit">
          <actions>
            <do_if value="player.entity.$RRData?" negate="true">
              <set_value name="player.entity.$RRData"
                exact="table[
                  $indexPre = [],
                  $dataPre = [],
                  $index = [],
                  $data = [],
                  $commanders = [],
                  $commandersIndex = [],
                  $commandersByShip = [],
                  $commandersByShipIndex = [],
                  $withoutCommanders = [],
                  $withoutCommandersIndex = [],
                  $pilotsToSwap = []
                ]" />
            </do_if>
          </actions>
        </library>

        <cue name="ProcessFleetUnitRequests" instantiate="true" namespace="this">
          <conditions>
            <!-- param2 = requester, param3 = [ships to be replaced] -->
            <event_object_signalled object="player.entity" param="'rr_reconstitute_fleet'" />
            <check_value value="event.param2.isoperational" />
            <check_value value="event.param2.isclass.controllable" />
            <check_value value="not event.param2.fleetunit" />
            <check_value value="@event.param3.count" />
          </conditions>
          <actions>
            <set_value name="$commander" exact="event.param2" />
            <do_if value="$commander.commander">
              <set_value name="$commander" exact="$commander.toplevelcommander" />
            </do_if>
            <do_if value="$commander.isclass.ship">
              <debug_text
                text="'RR_GetThemBack - FleetUnitsRequests: Commander: %s. FleetUnits Count: %s.'.[$commander.debugname, event.param3.count]"
                chance="100" />
              <do_if value="player.entity.$RRData? and @player.entity.$RRData.$withoutCommanders.count gt 0">
                <set_value name="$data" exact="player.entity.$RRData.$withoutCommanders" />
                <set_value name="$indexes" exact="player.entity.$RRData.$withoutCommandersIndex" />
                <do_for_each name="$fleetUnit" in="event.param3">
                  <set_value name="$index" exact="$indexes.indexof.{$fleetUnit.macro}" />
                  <debug_text text="'RR_GetThemBack - FleetUnitsRequests: Macro: %s, Index: %s'.[$fleetUnit.macro, $index]"
                    chance="100" />
                  <do_if value="$index gt 0">
                    <set_value name="$shipsInfo" exact="player.entity.$RRData.$withoutCommanders.{$index}" />
                    <debug_text text="'RR_GetThemBack - FleetUnitsRequests: Ships Info Count: %s'.[ $shipsInfo.count ]" />
                    <do_if value="$shipsInfo.count gt 0">
                      <set_value name="$shipInfo" exact="$shipsInfo.{$shipsInfo.count}" />
                      <remove_from_list name="$shipsInfo" exact="$shipInfo" />
                      <do_if value="$shipsInfo.count == 0">
                        <remove_from_list name="player.entity.$RRData.$withoutCommanders" exact="$shipsInfo" />
                        <remove_from_list name="player.entity.$RRData.$withoutCommandersIndex" exact="$fleetUnit.macro" />
                      </do_if>
                      <debug_text text="'RR_GetThemBack - FleetUnitsRequests: Ship Id: %s'.[ $shipInfo.$id ]" />
                      <append_to_list name="player.entity.$RRData.$commandersByShipIndex" exact="$shipInfo.$id" />
                      <append_to_list name="player.entity.$RRData.$commandersByShip" exact="$commander.idcode" />
                      <set_value name="$commanderIndex" exact="player.entity.$RRData.$commandersIndex.indexof.{$commander.idcode}" />
                      <do_if value="$commanderIndex le 0">
                        <append_to_list name="player.entity.$RRData.$commandersIndex" exact="$commander.idcode" />
                        <append_to_list name="player.entity.$RRData.$commanders"
                          exact="[table[$macro = $fleetUnit.macro, $id = $shipInfo.$id, $countMax = $shipInfo.$countMax, $count = 0, $replacement = null, $updated = player.age]]" />
                        <set_value name="$commanderIndex" exact="1" />
                      </do_if>
                      <do_else>
                        <append_to_list name="player.entity.$RRData.$commanders.{$commanderIndex}"
                          exact="table[$macro = $fleetUnit.macro, $id = $shipInfo.$id, $countMax = $shipInfo.$countMax, $count = 0, $replacement = null, $updated = player.age]" />
                      </do_else>
                      <debug_text
                        text="'RR_GetThemBack - FleetUnitsRequests: Commander %s set for %s via Macro: %s. Record: %s.'.
                        [
                          $commander.debugname,
                          $shipInfo.$id,
                          $fleetUnit.macro,
                          player.entity.$RRData.$commanders.{$commanderIndex}
                        ]"
                      />
                    </do_if>
                  </do_if>
                </do_for_each>
                <remove_value name="$data" />
                <remove_value name="$indexes" />
                <remove_value name="$shipsInfo" />
                <remove_value name="$shipInfo" />
                <remove_value name="$index" />
              </do_if>
              <do_else>
                <debug_text
                  text="'RR_GetThemBack - Commander %s is not a ship, unable to process fleet unit requests.'.[ $commander.debugname ]" />
              </do_else>
            </do_if>
            <remove_value name="$commander" />
          </actions>
        </cue>

        <cue name="ProcessCrewAccountingRequest" instantiate="true" namespace="this">
          <conditions>
            <!-- param2 = requester, param3 = [ships to be replaced] -->
            <event_object_signalled object="player.entity" param="'rr_entity_transfer'" />
            <check_value value="event.param2?" />
            <check_value value="@event.param3.$container.isclass.controllable" />
            <check_value value="event.param3.$containerTag?" />
          </conditions>
          <actions>
            <debug_text
              text="'RR_GetThemBack - ProcessCrewAccountingRequest started. Game version valid: %s. Data exists: %s. Param2: %s. Param3: %s. Container: %s, Type: %s'.
              [
                player.gameversion ge 750,
                player.entity.$RRData?,
                @event.param2,
                @event.param3,
                @event.param3.$container,
                @event.param3.$containerTag
              ]"
              chance="100" />
            <do_if value="player.gameversion ge 750 and player.entity.$RRData?">
              <set_value name="$rescuedEntity" exact="event.param2" />
              <set_value name="$rescuedEntityContainer" exact="event.param3.$container" />
              <set_value name="$rescuedEntityContainerTag" exact="event.param3.$containerTag" />
              <do_if value="$rescuedEntityContainerTag == 'rescuer' and @player.entity.$RRData.$indexPre.count gt 0">
                <set_value name="$dataIndex" exact="player.entity.$RRData.$indexPre.indexof.{$rescuedEntity}" />
                <do_if value="$dataIndex gt 0">
                  <set_value name="$dataItem" exact="player.entity.$RRData.$dataPre.{$dataIndex}" />
                  <remove_from_list name="player.entity.$RRData.$dataPre" exact="$dataItem" />
                  <remove_from_list name="player.entity.$RRData.$indexPre" exact="$rescuedEntity" />
                  <set_value name="$dataItem.$containerId" exact="$rescuedEntityContainer.idcode" />
                  <set_value name="$dataItem.$containerTag" exact="$rescuedEntityContainerTag" />
                  <set_value name="$dataItem.$containerClass" exact="$rescuedEntityContainer.class" /> <!-- Set the class -->
                  <set_value name="$dataItem.$containerType" exact="$rescuedEntityContainer.type" /> <!-- Set the type -->
                  <set_value name="$dataItem.$updated" exact="player.age" /> <!-- Set the update timestamp -->
                  <set_value name="$containerPersons" exact="$rescuedEntityContainer.availablepeople.{entityrole.unassigned}.list" />
                  <do_for_each name="$containerPerson" in="$containerPersons">
                    <do_if value="$rescuedEntityContainer.availablepeople.{$containerPerson}.name == $rescuedEntity">
                      <set_value name="$dataItem.$id" exact="$containerPerson" />
                    </do_if>
                  </do_for_each>
                  <append_to_list name="player.entity.$RRData.$index" exact="$rescuedEntity" />
                  <append_to_list name="player.entity.$RRData.$data" exact="$dataItem" />
                  <set_value name="$commanderByShipIndex" exact="@player.entity.$RRData.$commandersIndex.indexof.{$dataItem.$shipId}" />
                  <set_value name="$commanderId" exact="@player.entity.$RRData.$commandersByShip.{@$commanderByShipIndex}" />
                  <set_value name="$commanderIndex" exact="@player.entity.$RRData.$commandersIndex.indexof.{@$commanderId}" />
                  <set_value name="$commanderData" exact="@player.entity.$RRData.$commanders.{@$commanderIndex}" />
                  <debug_text
                    text="'RR_GetThemBack - ProcessCrewAccountingRequest: Ship Info Item to be updated: Ship: %s, Commander: Index: %s, Id: %s, Data: %s'.
                    [
                      $dataItem.$shipId,
                      $commanderIndex,
                      $commanderId,
                      $commanderData
                    ]"
                    chance="100" />
                  <do_if value="@$commanderData != null and $commanderData.count gt 0">
                    <set_value name="$commanderData.$countMax" operation="add" />
                    <do_for_each name="$shipInfo" in="$commanderData">
                      <do_if value="$shipInfo.$id == $dataItem.$shipId">
                        <set_value name="$shipInfo.$count" operation="add" />
                        <break />
                      </do_if>
                    </do_for_each>
                  </do_if>
                  <remove_value name="$shipInfo" />
                  <remove_value name="$commanderData" />
                  <remove_value name="$commanderIndex" />
                  <remove_value name="$commanderId" />
                  <remove_value name="$commanderByShipIndex" />
                  <debug_text
                    text="'RR_GetThemBack - ProcessCrewAccountingRequest : Data Item Updated for %s: %s'.[$rescuedEntity, $dataItem]"
                    chance="100" />
                </do_if>
              </do_if>
              <do_elseif value="$rescuedEntityContainerTag == 'dormitory' and @player.entity.$RRData.$dataIndex.count gt 0">
                <set_value name="$dataIndex" exact="player.entity.$RRData.$dataIndex.indexof.{$rescuedEntity}" />
                <do_if value="$dataIndex gt 0">
                  <set_value name="player.entity.$RRData.$data.{$dataIndex}.$containerId" exact="$rescuedEntityContainer.idcode" />
                  <set_value name="player.entity.$RRData.$data.{$dataIndex}.$containerTag" exact="$rescuedEntityContainerTag" />
                  <set_value name="player.entity.$RRData.$data.{$dataIndex}.$containerClass" exact="$rescuedEntityContainer.class" />
                  <set_value name="player.entity.$RRData.$data.{$dataIndex}.$containerType" exact="$rescuedEntityContainer.type" />
                  <set_value name="player.entity.$RRData.$data.{$dataIndex}.$updated" exact="player.age" /> <!-- Set the update timestamp -->
                  <debug_text
                    text="'RR_GetThemBack - ProcessCrewAccountingRequest: Data Item Updated for %s: %s'.[$rescuedEntity, player.entity.$RRData.$data.{$dataIndex} ]"
                    chance="100" />
                </do_if>
              </do_elseif>
            </do_if>
            <remove_value name="$dataIndex" />
            <remove_value name="$dataItem" />
            <remove_value name="$containerPersons" />
            <remove_value name="$containerPerson" />
            <remove_value name="$rescuedEntity" />
            <remove_value name="$rescuedEntityId" />
            <remove_value name="$rescuedEntityContainerTag" />
            <remove_value name="$rescuedEntityContainer" />
          </actions>
        </cue>

        <cue name="RefreshRRData" instantiate="true" checkinterval="60s" namespace="this">
          <actions>
            <do_if value="player.entity.$RRData.$dataPre?">
              <set_value name="$dataIndex" exact="1" />
              <do_while value="$dataIndex le player.entity.$RRData.$dataPre.count">
                <set_value name="$dataItem" exact="@player.entity.$RRData.$dataPre.{$dataIndex}" />
                <do_if value="player.age gt ($dataItem.$updated + 1800)">
                  <remove_from_list name="player.entity.$RRData.$indexPre" exact="$dataItem.$name" />
                  <remove_from_list name="player.entity.$RRData.$dataPre" exact="$dataItem" />
                  <debug_text text="'RR_GetThemBack - Refresh Data: Removed %s from Spacesuits'.[ $dataItem.$name ]" />
                  <do_if value="$dataIndex == player.entity.$RRData.$dataPre.count">
                    <break />
                  </do_if>
                </do_if>
                <do_else>
                  <set_value name="$dataIndex" operation="add" />
                </do_else>
              </do_while>
            </do_if>
            <do_if value="player.entity.$RRData.$data?">
              <set_value name="$dataIndex" exact="1" />
              <do_while value="$dataIndex le player.entity.$RRData.$data.count">
                <set_value name="$dataItem" exact="@player.entity.$RRData.$data.{$dataIndex}" />
                <do_if value="player.age gt ($dataItem.$updated + 7200)">
                  <remove_from_list name="player.entity.$RRData.$index" exact="$dataItem.$name" />
                  <remove_from_list name="player.entity.$RRData.$data" exact="$dataItem" />
                  <debug_text text="'RR_GetThemBack - Refresh Data: Removed %s from Dormitories'.[ $dataItem.$name ]" />
                  <do_if value="$dataIndex == player.entity.$RRData.$data.count">
                    <break />
                  </do_if>
                </do_if>
                <do_else>
                  <set_value name="$dataIndex" operation="add" />
                </do_else>
              </do_while>
            </do_if>
            <!-- TODO: Cleanup withoutCommander and Commanders -->
            <remove_value name="$dataItem" />
            <remove_value name="$dataIndex" />
          </actions>
        </cue>

        <cue name="ReplacementShipBuilded" instantiate="true" namespace="this">
          <conditions>
            <!-- param2 = requester, param3 = [ships to be replaced] -->
            <event_object_signalled object="player.entity" param="'rr_reinstate_fleet_builded'" />
            <check_value value="@event.param2.isclass.controllable" />
            <check_value value="@event.param3.isclass.controllable" />
          </conditions>
          <actions>
            <set_value name="$replacement" exact="event.param2" />
            <set_value name="$commander" exact="event.param3" />
            <do_if value="$commander.toplevelcommander">
              <set_value name="$commander" exact="$commander.toplevelcommander" />
            </do_if>
            <debug_text
              text="'RR_GetThemBack - ReplacementShipBuilded: Data exists: %s. Records count: %s. Input: Commander: %s. Replacement: %s. Macro: %s'.
              [
                player.entity.$RRData?,
                player.entity.$RRData.$index.count,
                $commander.debugname,
                $replacement.debugname,
                $replacement.macro
              ]"
              chance="100" />
            <do_if value="player.entity.$RRData? and @player.entity.$RRData.$commandersIndex.count gt 0">
              <set_value name="$commanderIndex" exact="player.entity.$RRData.$commandersIndex.indexof.{$commander.idcode}" />
              <debug_text text="'RR_GetThemBack - ReplacementShipBuilded: Commander Index: %s'.[ $commanderIndex ]" chance="100" />
              <do_if value="$commanderIndex gt 0">
                <set_value name="$commanderData" exact="player.entity.$RRData.$commanders.{$commanderIndex}" />
                <debug_text
                  text="'RR_GetThemBack - ReplacementShipBuilded: Commander Data: %s. Count: %s'.[ $commanderData,  $commanderData.count]"
                  chance="100" />
                <do_for_each name="$shipInfoItem" in="$commanderData">
                  <debug_text text="'RR_GetThemBack - ReplacementShipBuilded: ShipInfoItem: %s'.[ $shipInfoItem ]" chance="100" />
                  <do_if value="@$shipInfoItem.$macro == $replacement.macro and @$shipInfoItem.$replacement == null">
                    <set_value name="$shipInfoItem.$replacement" exact="$replacement.idcode" />
                    <debug_text text="'RR_GetThemBack - ReplacementShipBuilded: ShipInfoItem Updated: %s'.[ $shipInfoItem ]" chance="100" />
                    <break />
                  </do_if>
                </do_for_each>
              </do_if>
            </do_if>
          </actions>
        </cue>

        <cue name="RecoveryCrewOnReplacementShip" instantiate="true" namespace="this">
          <conditions>
            <!-- param2 = requester, param3 = [ships to be replaced] -->
            <event_object_signalled object="player.entity" param="'rr_reinstate_fleet_ship'" />
            <check_value value="@event.param2.isclass.controllable" />
            <check_value value="@event.param3.isclass.controllable" />
          </conditions>
          <actions>
            <set_value name="$replacement" exact="event.param2" />
            <set_value name="$commander" exact="event.param3" />
            <do_if value="$commander.toplevelcommander">
              <set_value name="$commander" exact="$commander.toplevelcommander" />
            </do_if>
            <debug_text
              text="'RR_GetThemBack - RecoveryCrew: Data exists: %s. Records count: %s. Input: Commander: %s. Replacement: %s. Macro: %s'.
              [
                player.entity.$RRData?,
                player.entity.$RRData.$index.count,
                $commander.debugname,
                $replacement.debugname,
                $replacement.macro
              ]"
              chance="100" />
            <set_value name="$shipInfo" exact="null" />
            <do_if value="player.entity.$RRData? and @player.entity.$RRData.commandersIndex.count gt 0">
              <set_value name="$commanderIndex" exact="player.entity.$RRData.$commandersIndex.indexof.{$commander.idcode}" />
              <debug_text text="'RR_GetThemBack - RecoveryCrew: Commander Index: %s'.[ $commanderIndex ]" chance="100" />
              <do_if value="$commanderIndex gt 0">
                <set_value name="$commanderData" exact="player.entity.$RRData.$commanders.{$commanderIndex}" />
                <debug_text text="'RR_GetThemBack - RecoveryCrew: Commander Data: %s. Count: %s'.[ $commanderData,  $commanderData.count]"
                  chance="100" />
                <do_for_each name="$shipInfoItem" in="$commanderData">
                  <debug_text text="'RR_GetThemBack - RecoveryCrew: ShipInfoItem: %s'.[ $shipInfoItem ]" chance="100" />
                  <do_if value="@$shipInfoItem.$replacement == $replacement.$idcode">
                    <debug_text text="'RR_GetThemBack - RecoveryCrew: Matched ShipInfoItem: %s'.[ $shipInfoItem ]" chance="100" />
                    <remove_from_list name="player.entity.$RRData.$commanders.{$commanderIndex}" exact="$shipInfoItem" />
                    <set_value name="$commanderByShipIndex" exact="player.entity.$RRData.$commandersByShipIndex.indexof.{$shipInfoItem.$id}" />
                    <remove_from_list name="player.entity.$RRData.$commandersByShipIndex" exact="$shipInfoItem.$id" />
                    <remove_value name="player.entity.$RRData.$commandersByShip.{$commanderByShipIndex}" />
                    <remove_value name="$commanderByShipIndex" />
                    <set_value name="$shipInfo" exact="$shipInfoItem" />
                    <break />
                  </do_if>
                </do_for_each>
                <do_if value="$shipInfo?">
                  <debug_text
                    text="'RR_GetThemBack - RecoveryCrew: ShipInfo: %s, Ship: %s, Macro: %s, ID: %s'.
                    [
                      @$shipInfo,
                      $replacement.debugname,
                      $replacement.macro,
                      @$shipInfo.$id
                    ]"
                    chance="100" />
                </do_if>
                <do_else>
                  <debug_text
                    text="'RR_GetThemBack - RecoveryCrew: No data for recovery found by Replacement Id : %s for Commander: %s'.
                    [$replacement.debugname, $commander.debugname]"
                    chance="100" />
                </do_else>
              </do_if>
              <do_else>
                <debug_text
                  text="'RR_GetThemBack - RecoveryCrew: Commander %s not in a list: %s'.[$commander.debugname, player.entity.$RRData.$commanders]"
                  chance="100" />
              </do_else>
            </do_if>
            <do_if value="$shipInfo != null and player.entity.$RRData? and @player.entity.$RRData.$index.count gt 0">
              <set_value name="$data" exact="player.entity.$RRData.$data" />
              <create_list name="$replacementCrew" />
              <create_list name="$replacementCrewIndex" />
              <create_list name="$dormitories" />
              <create_list name="$dormitoriesEntities" />
              <create_list name="$dormitoriesIndex" />
              <set_value name="$index" exact="1" />
              <do_while value="$index le $data.count">
                <set_value name="$person" exact="$data.{$index}" />
                <do_if value="@$person.$shipId == @$shipInfo.$id and @$person.$macro == $replacement.macro ">
                  <remove_from_list name="player.entity.$RRData.$data" exact="$person" />
                  <remove_from_list name="player.entity.$RRData.$index" exact="$person.$name" />
                  <debug_text text="'RR_GetThemBack - RecoveryCrew: Person added to replacement crew: %s'.[ $person ]" chance="100" />
                  <debug_text text="'RR_GetThemBack - RecoveryCrew: Crew member: %s'.[ $person ]" chance="100" />
                  <set_value name="$dormitoryIndex" exact="$dormitoriesIndex.indexof.{$person.$containerId}" />
                  <do_if value="$dormitoryIndex le 0">
                    <append_to_list name="$dormitoriesIndex" exact="$person.$containerId" />
                    <append_to_list name="$dormitoriesEntities" exact="[]" />
                    <append_to_list name="$dormitories" exact="null" />
                    <set_value name="$dormitoryIndex" exact="$dormitoriesIndex.count" />
                    <find_ship_by_true_owner faction="faction.player" name="$dormitoryShips" space="player.galaxy"
                      class="$person.$containerClass"
                      shiptype="$person.$containerType"
                      checkoperational="true"
                      multiple="true" />
                    <debug_text text="'RR_GetThemBack - RecoveryCrew: Possible Dormitory Ships: %s'.[ $dormitoryShips ]" chance="100" />
                    <do_for_each name="$dormitoryShip" in="$dormitoryShips">
                      <do_if value="$dormitoryShip.idcode == $person.$containerId">
                        <set_value name="$dormitories.{$dormitoryIndex}" exact="$dormitoryShip" />
                        <debug_text
                          text="'RR_GetThemBack - RecoveryCrew: Dormitory: %s, Entities count: %s'.
                                [
                                  $dormitoryShip.debugname,
                                  $dormitoryShip.availablepeople.{entityrole.unassigned}.count
                                ]
                              "
                          chance="100" />
                        <break />
                      </do_if>
                    </do_for_each>
                  </do_if>
                  <do_if value="$dormitories.{$dormitoryIndex}?">
                    <set_value name="$person.$container" exact="$dormitories.{$dormitoryIndex}" />
                    <append_to_list name="$replacementCrew" exact="$person" />
                    <append_to_list name="$replacementCrewIndex" exact="$person.$name" />
                    <append_to_list name="$dormitoriesEntities.{$dormitoryIndex}" exact="$person" />
                    <debug_text
                      text="'RR_GetThemBack - RecoveryCrew: Dormitory: %s, Entities: %s, Count: %s'.
                        [
                          $dormitories.{$dormitoryIndex}.debugname,
                          $dormitoriesEntities.{$dormitoryIndex},
                          $dormitoriesEntities.{$dormitoryIndex}.count
                       ]"
                      chance="100" />
                  </do_if>
                  <do_else>
                    <debug_text text="'RR_GetThemBack - RecoveryCrew: No Dormitory found for %s. Skipped!'.[ $person.$name ]"
                      chance="100" />
                  </do_else>
                </do_if>
                <do_else>
                  <set_value name="$index" operation="add" />
                </do_else>
              </do_while>
              <debug_text text="'RR_GetThemBack - RecoveryCrew: Replacement crew count: %s'.[ $replacementCrew.count ]"
                chance="100" />
              <do_if value="@$replacementCrew.count gt 0">
                <debug_text text="'RR_GetThemBack - RecoveryCrew: Replacement crew: %s'.[ $replacementCrew ]" chance="100" />
                <debug_text
                  text="'RR_GetThemBack - RecoveryCrew: Dormitories with possible crew members: %s (%s)'.
                        [
                          $dormitoriesIndex,
                          $dormitories,
                        ]
                      "
                  chance="100" />
                <create_list name="$pilots" />
                <append_list_elements name="$pilots" other="$replacementCrew" />
                <sort_list list="$pilots" sortbyvalue="loop.element.$container.availablepeople.{loop.element.$id}.skill.piloting"
                  sortdescending="true" />
                <debug_text
                  text="'RR_GetThemBack - RecoveryCrew: Best Pilot: %s. Skill: %s'.
                      [ @$pilots.{1}.$name, @$pilots.{1}.$container.availablepeople.{@$pilots.{1}.$id}.skill.piloting]"
                  chance="100" />
                <debug_text
                  text="'RR_GetThemBack - RecoveryCrew: CurrentPilot %s. Role: %s. Post: %s'.[
                        @$replacement.aipilot.name,
                        @$replacement.aipilot.role.name,
                        @$replacement.aipilot.controlpost.name,
                      ]"
                  chance="100" />
                <set_value name="$pilotNew" exact="null" />
                <do_if
                  value="$pilots.{1}? and @$pilots.{1}.$container.availablepeople.{@$pilots.{1}.$id}.skill.piloting gt $replacement.aipilot.skill.piloting">
                  <set_value name="$pilotNew" exact="$pilots.{1}" />
                  <remove_from_list name="$replacementCrew" exact="$pilotNew" />
                  <set_value name="$dormitoryIndex" exact="$dormitoriesIndex.indexof.{$pilotNew.$containerId}" />
                  <do_if value="$dormitoryIndex gt 0">
                    <remove_from_list name="$dormitoriesEntities.{$dormitoryIndex}" exact="$pilotNew" />
                  </do_if>
                  <remove_value name="$dormitoryIndex" />
                </do_if>
                <clear_list list="$pilots" />
                <remove_value name="$pilots" />
                <debug_text
                  text="'RR_GetThemBack - RecoveryCrew: Current crew: %s. Count: %s. Capacity: %s. Free: %s. Count: %s.'.
                      [
                        $replacement.availablepeople.list,
                        $replacement.availablepeople.count,
                        $replacement.people.capacity,
                        $replacement.people.free,
                        $replacement.people.count
                      ]"
                  chance="100" />
                <create_list name="$crewLocal" />
                <do_for_each name="$person" in="$replacement.availablepeople.list">
                  <debug_text
                    text="'RR_GetThemBack - RecoveryCrew: Person: %s. Role: %s. Control Post: %s'.
                        [ $person, @$replacement.people.{$person}.role.name, @$replacement.people.{$person}.controlpost.name ]"
                    chance="100" />
                  <do_if value="$replacement.availablepeople.{$person}.role == entityrole.unassigned" negate="true">
                    <set_npc_template_role object="$replacement" template="$person" role="entityrole.unassigned" />
                  </do_if>
                  <append_to_list name="$crewLocal" exact="$person" />
                </do_for_each>
                <set_value name="$crewDelta" exact="$replacementCrew.count - $replacement.people.free" />
                <do_if value="$pilotNew? and @$pilotNew != null">
                  <set_value name="$crewDelta" operation="add" />
                </do_if>
                <debug_text
                  text="'RR_GetThemBack - RecoveryCrew: Crew Delta: %s. New Crew Count: %s. Existing Crew: %s. Free: %s. To Clear: %s'.
                      [
                        $crewDelta,
                        $replacementCrew.count,
                        $replacement.people.count,
                        $replacement.people.free,
                        ($replacementCrew.count gt 0 or $crewLocal.count gt 0) and $crewDelta gt 0
                      ]"
                  chance="100" />
                <do_if value="($replacementCrew.count gt 0 or $crewLocal.count gt 0) and $crewDelta gt 0">
                  <debug_text
                    text="'RR_GetThemBack - RecoveryCrew: Not enough space for the replacement Crew. Delta: %s. But we can fire some one...'.
                        [
                          $crewDelta,
                        ]"
                    chance="100" />
                  <sort_list list="$crewLocal" sortbyvalue="$replacement.availablepeople.{loop.element.$id}.combinedskill"
                    sortdescending="false" />
                  <sort_list list="$replacementCrew"
                    sortbyvalue="@loop.element.$container.availablepeople.{loop.element.$id}.combinedskill"
                    sortdescending="false" />
                  <do_while value="$crewDelta gt 0 and ($replacementCrew.count gt 0 or $crewLocal.count gt 0)">
                    <do_if value="$crewLocal.count gt 0 and $replacementCrew.count gt 0">
                      <set_value name="$personLowestLocal" exact="$crewLocal.{1}" />
                      <set_value name="$personLowestNew" exact="$replacementCrew.{1}" />
                      <debug_text
                        text="'RR_GetThemBack - RecoveryCrew: Lowest persons: Local: %s - %s, New: %s - %s'.
                            [
                              @$replacement.availablepeople.{$personLowestLocal}.name,
                              @$replacement.availablepeople.{$personLowestLocal}.combinedskill,
                              @$personLowestNew.$container.availablepeople.{$personLowestNew.$id}.name,
                              @$personLowestNew.$container.availablepeople.{$personLowestNew.$id}.combinedskill
                            ]"
                        chance="100" />
                      <do_if
                        value="@$replacement.availablepeople.{$personLowestLocal}.combinedskill lt @$personLowestNew.$container.availablepeople.{$personLowestNew.$id}.combinedskill">
                        <remove_from_list name="$crewLocal" exact="$personLowestLocal" />
                        <debug_text
                          text="'RR_GetThemBack - RecoveryCrew: Person to fire: %s'.
                                [ @$replacement.availablepeople.{$personLowestLocal}.name ]"
                          chance="100" />
                        <remove_npc_template object="$replacement" template="$personLowestLocal" />
                      </do_if>
                      <do_else>
                        <remove_from_list name="$replacementCrew" exact="$personLowestNew" />
                        <debug_text
                          text="'RR_GetThemBack - RecoveryCrew: Person to fire: %s'.
                                [ @$personLowestNew.$container.availablepeople.{$personLowestNew.$id}.name ]"
                          chance="100" />
                        <set_value name="$dormitoryIndex" exact="$dormitoriesIndex.indexof.{$personLowestNew.$containerId}" />
                        <do_if value="$dormitoryIndex gt 0">
                          <remove_from_list name="$dormitoriesEntities.{$dormitoryIndex}" exact="$personLowestNew" />
                        </do_if>
                        <remove_from_list name="$replacementCrew" exact="$personLowestNew" />
                        <remove_npc_template object="@$personLowestNew.$container" template="$personLowestNew.$id" />
                        <remove_value name="$dormitoryIndex" />
                      </do_else>
                      <remove_value name="$personLowestLocal" />
                      <remove_value name="$personLowestNew" />
                    </do_if>
                    <do_elseif value="$replacementCrew.count gt 0">
                      <set_value name="$personLowestNew" exact="$replacementCrew.{1}" />
                      <debug_text
                        text="'RR_GetThemBack - RecoveryCrew: Person to fire: %s'.
                              [ @$personLowestNew.$container.availablepeople.{$personLowestNew.$id}.name ]"
                        chance="100" />
                      <set_value name="$dormitoryIndex" exact="$dormitoriesIndex.indexof.{$personLowestNew.$containerId}" />
                      <do_if value="$dormitoryIndex gt 0">
                        <remove_from_list name="$dormitoriesEntities.{$dormitoryIndex}" exact="$personLowestNew" />
                      </do_if>
                      <remove_from_list name="$replacementCrew" exact="$personLowestNew" />
                      <remove_npc_template object="@$personLowestNew.$container" template="$personLowestNew.$id" />
                      <remove_value name="$personLowestNew" />
                      <remove_value name="$dormitoryIndex" />
                    </do_elseif>
                    <do_else>
                      <set_value name="$personLowestLocal" exact="$crewLocal.{1}" />
                      <debug_text
                        text="'RR_GetThemBack - RecoveryCrew: Person to fire: %s'.
                              [ @$replacement.availablepeople.{$personLowestLocal}.name ]"
                        chance="100" />
                      <remove_from_list name="$crewLocal" exact="$personLowestLocal" />
                      <remove_npc_template object="$replacement" template="$personLowestLocal" />
                      <remove_value name="$personLowestLocal" />
                    </do_else>
                    <set_value name="$crewDelta" operation="subtract" />
                  </do_while>
                </do_if>
                <do_for_each name="$dormitory" in="$dormitories" counter="$dormitoryIndex">
                  <debug_text
                    text="'RR_GetThemBack - RecoveryCrew on Dormitory: %s, Entities: %s, Count: %s'.
                        [
                          $dormitory.debugname,
                          $dormitoriesEntities.{$dormitoryIndex},
                          $dormitoriesEntities.{$dormitoryIndex}.count
                        ]"
                    chance="100" />
                  <create_list name="$crewToTransfer" />
                  <do_for_each name="$crewMember" in="$dormitoriesEntities.{$dormitoryIndex}">
                    <debug_text text="'RR_GetThemBack - RecoveryCrew: Crew member to Transfer: %s'.[ $crewMember ]" chance="100" />
                    <append_to_list name="$crewToTransfer" exact="$crewMember.$id" />
                  </do_for_each>
                  <do_while value="$crewToTransfer.count gt 0">
                    <debug_text
                      text="'RR_GetThemBack - RecoveryCrew: Crew to transfer from Dormitory : %s, Entities: %s, Count: %s'.
                          [
                            $dormitory.debugname,
                            $crewToTransfer,
                            $crewToTransfer.count
                          ]"
                      chance="100" />
                    <transfer_people result="$crewTransferred" object="$replacement" otherobject="$dormitory"
                      receiveworkforce="false">
                      <existing_people people="$crewToTransfer" />
                    </transfer_people>
                    <set_value name="$crewToTransferIndex" exact="1" />
                    <do_while value="$crewToTransferIndex le $crewToTransfer.count">
                      <set_value name="$crewMember" exact="$crewToTransfer.{$crewToTransferIndex}" />
                      <do_if value="$crewTransferred.indexof.{$crewMember} gt 0">
                        <remove_from_list name="$crewToTransfer" exact="$crewMember" />
                      </do_if>
                      <do_else>
                        <set_value name="$crewToTransferIndex" operation="add" />
                      </do_else>
                    </do_while>
                    <debug_text
                      text="'RR_GetThemBack - RecoveryCrew: Crew transferred: %s. Count: %s. \nLeaved: %s. Count: %s.'.
                            [ $crewTransferred, $crewTransferred.count, $crewToTransfer, $crewToTransfer.count ]"
                      chance="100" />
                  </do_while>
                  <clear_list list="$dormitoriesEntities.{$dormitoryIndex}" />
                </do_for_each>
                <clear_list list="$dormitories" />
                <clear_list list="$dormitoriesEntities" />
                <clear_list list="$dormitoriesIndex" />
                <set_value name="$unassignedList" exact="$replacement.availablepeople.{entityrole.unassigned}.list" />
                <set_value name="$personIndex" exact="1" />
                <do_while value="$personIndex le $replacementCrew.count">
                  <set_value name="$person" exact="$replacementCrew.{$personIndex}" />
                  <do_if value="$unassignedList.indexof.{$person.$id} le 0">
                    <debug_text text="'RR_GetThemBack - RecoveryCrew: Person not transferred: %s'.[ $person.$name ]" chance="100" />
                    <remove_from_list name="$replacementCrew" exact="$person" />
                    <remove_from_list name="$replacementCrewIndex" exact="$person.$name" />
                  </do_if>
                  <do_else>
                    <set_value name="$personIndex" operation="add" />
                  </do_else>
                </do_while>
                <do_if value="$replacementCrew.count gt 0">
                  <debug_text text="'RR_GetThemBack - RecoveryCrew: Replacement crew: %s'.[ $replacementCrew ]" chance="100" />

                  <debug_text
                    text="'RR_GetThemBack - RecoveryCrew: Current Pilot: %s. Skill: %s'.
                        [ $replacement.aipilot.knownname, $replacement.aipilot.skill.piloting ]"
                    chance="100" />
                  <do_if value="$pilotNew? and @$pilotNew != null">
                    <transfer_people result="$crewTransferred" object="$replacement" otherobject="$pilotNew.$container"
                      receiveworkforce="false">
                      <existing_people people="[$pilotNew.$id]" />
                    </transfer_people>
                    <debug_text
                      text="'RR_GetThemBack - RecoveryCrew: Pilot transferred: %s'.
                          [$crewTransferred.count gt 0 and $pilotNew.$id == $crewTransferred.{1}]"
                      chance="100" />
                    <do_if value="$crewTransferred.count gt 0 and $pilotNew.$id == $crewTransferred.{1}">
                      <assign_hired_actor actor="[$replacement, $pilotNew.$id]" target="$replacement"
                        post="controlpost.aipilot" success="$pilotsSwappingResult" failed="$pilotsSwappingMessage" />
                      <debug_text
                        text="'RR_GetThemBack - RecoveryCrew: Swap Pilots: Result: %s. Message: %s'.[$pilotsSwappingResult, $pilotsSwappingMessage ]"
                        chance="100" />
                      <do_if value="$pilotsSwappingResult" negate="true">
                        <append_to_list name="player.entity.$RRData.$pilotsToSwap"
                          exact="table[$ship = $replacement, $shipId = $replacement.idcode, $pilot = $pilotNew.$id, $updated = player.age]" />
                        <debug_text
                          text="'RR_GetThemBack - RecoveryCrew: Pilot to swap added: %s'.
                                [@player.entity.$RRData.$pilotsToSwap.last]"
                          chance="100" />
                      </do_if>
                    </do_if>
                    <do_else>
                      <debug_text text="'RR_GetThemBack - RecoveryCrew: Pilot not transferred: %s'.[ $pilotNew.$id ]" chance="100" />
                    </do_else>
                  </do_if>
                  <set_value name="$crewUnassigned" exact="$replacement.availablepeople.{entityrole.unassigned}.list" />
                  <do_for_each name="$crewMember" in="$crewUnassigned">
                    <do_if
                      value="$replacement.availablepeople.{$crewMember}.skill.engineering gt $replacement.availablepeople.{$crewMember}.skill.boarding">
                      <set_npc_template_role template="$crewMember" object="$replacement" role="entityrole.service" />
                      <debug_text
                        text="'RR_GetThemBack - RecoveryCrew: Crew member %s assigned as Service Man'.
                            [ $replacement.availablepeople.{$crewMember}.name ]"
                        chance="100" />
                    </do_if>
                    <do_else>
                      <set_npc_template_role template="$crewMember" object="$replacement" role="entityrole.marine" />
                      <debug_text
                        text="'RR_GetThemBack - RecoveryCrew: Crew member %s assigned as Marine'.
                            [ $replacement.availablepeople.{$crewMember}.name ]"
                        chance="100" />
                    </do_else>
                  </do_for_each>
                </do_if>
                <do_else>
                  <debug_text text="'RR_GetThemBack - RecoveryCrew: Nobody transferred to %s'.[ $replacement.debugname ]" chance="100" />
                </do_else>
              </do_if>
            </do_if>
            <do_else>
              <debug_text text="'RR_GetThemBack - RecoveryCrew: No data for recovery'" chance="100" />
            </do_else>
            <remove_value name="$person" />
            <remove_value name="$crewMember" />
            <remove_value name="$dormitory" />
            <remove_value name="$dormitoryIndex" />
            <remove_value name="$dormitories" />
            <remove_value name="$dormitoriesEntities" />
            <remove_value name="$dormitoriesIndex" />
            <remove_value name="$dormitoriesClasses" />
            <remove_value name="$replacementCrew" />
            <remove_value name="$replacementCrewIndex" />
            <remove_value name="$data" />
            <remove_value name="$replacementCrew" />
            <remove_value name="$replacementCrewIndex" />
            <remove_value name="$commanderIndex" />
            <remove_value name="$commander" />
            <remove_value name="$replacement" />
          </actions>
        </cue>

        <cue name="SwapPilots" instantiate="true" checkinterval="5s" namespace="this">
          <conditions>
            <check_value value="@player.entity.$RRData.$pilotsToSwap.count gt 0" />
          </conditions>
          <actions>
            <set_value name="$swapIndex" exact="1" />
            <do_while value="$swapIndex le @player.entity.$RRData.$pilotsToSwap.count">
              <set_value name="$swapInfo" exact="@player.entity.$RRData.$pilotsToSwap.{$swapIndex}" />
              <debug_text text="'RR_GetThemBack - SwapPilots: Swapping pilots record %s'.
                [ $swapInfo ]" chance="100" />
              <do_if value="@$swapInfo.$ship.isoperational">
                <assign_hired_actor actor="[$swapInfo.$ship, $swapInfo.$pilot]" target="$swapInfo.$ship"
                  post="controlpost.aipilot" success="$pilotsSwappingResult" failed="$pilotsSwappingMessage" />
                <do_if value="$pilotsSwappingResult">
                  <debug_text
                    text="'RR_GetThemBack - SwapPilots: Pilot %s swapped on %s.'
                    [ @$swapInfo.$ship.aipilot.knownname, $swapInfo.$ship.debugname ]"
                    chance="100" />
                  <remove_from_list name="@player.entity.$RRData.$pilotsToSwap" exact="$swapInfo" />
                </do_if>
                <do_else>
                  <debug_text
                    text="'RR_GetThemBack - RecoveryCrew: Pilot swap failed: %s'.[$pilotsSwappingMessage]" chance="100" />
                  <do_if value="$swapInfo.$updated + 300 lt player.age">
                    <remove_from_list name="@player.entity.$RRData.$pilotsToSwap" exact="$swapInfo" />
                    <debug_text text="'RR_GetThemBack - SwapPilots: Pilot swap record removed: %s'.
                      [ $swapInfo ]"
                      chance="100" />
                  </do_if>
                  <do_else>
                    <set_value name="$swapIndex" operation="add" />
                  </do_else>
                </do_else>
              </do_if>
              <do_else>
                <remove_from_list name="@player.entity.$RRData.$pilotsToSwap" exact="$swapInfo" />
                <debug_text
                  text="'RR_GetThemBack - SwapPilots: Ship %s is not operational. Pilot swap record removed: %s'.
                  [ $swapInfo.$ship.debugname, $swapInfo ]"
                  chance="100" />
              </do_else>
            </do_while>
            <remove_value name="$swapInfo" />
            <remove_value name="$swapIndex" />
            <remove_value name="$pilotsSwappingResult" />
            <remove_value name="$pilotsSwappingMessage" />
          </actions>
        </cue>

      </cues>
    </cue>
  </cues>
</mdscript>