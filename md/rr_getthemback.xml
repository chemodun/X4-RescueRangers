<?xml version="1.0" encoding="utf-8"?>
<mdscript name="RR_GetThemBack" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="md.xsd">
  <cues>
    <cue name="Init" version="105">
      <conditions>
        <event_cue_signalled cue="md.Setup.Start" />
      </conditions>
      <actions>
      </actions>
      <cues>

        <cue name="CollectCrewInfoFromDestroyedShip" instantiate="true" namespace="this">
          <conditions>
            <event_player_owned_destroyed />
            <check_value
              value="event.param.isclass.defensible and not event.param.ismasstraffic and not event.param.isunit and not event.param.isdeployable and not event.param.isclass.ship_xs and not event.param.isclass.buildstorage" />
            <check_value value="event.param3 != killmethod.collected" />
            <check_value value="event.param3 != killmethod.removed" comment="spacesuit is removed" />
            <check_value value="@player.entity.$RRGetThemBackEnabled + 300 ge player.age" />
          </conditions>
          <actions>
            <set_value name="$destroyedShip" exact="event.param" />
            <set_value name="$destroyTimestamp" exact="player.age" />
            <set_value name="$destroyedAt" exact="$destroyedShip.sector" />
            <include_actions ref="RRDataInit" />
            <set_value name="$shipInfo"
              exact="table[
                $id = $destroyedShip.idcode,
                $macro = $destroyedShip.macro,
                $count = 0,
                $countMax = 0,
                $commander = null,
                $replacement = null,
                $updated = player.age
              ]" />
            <set_value name="$shipIndex" exact="player.entity.$RRData.$destroyedIndex.indexof.{$destroyedShip.idcode}" />
            <do_if value="$shipIndex le 0">
              <append_to_list name="player.entity.$RRData.$destroyed" exact="$shipInfo" />
              <append_to_list name="player.entity.$RRData.$destroyedIndex" exact="$destroyedShip.idcode" />
            </do_if>
            <do_else>
              <debug_text
                text="'RR_GetThemBack - Collect Crew Info [%s]: Ship %s is already in the list'.[ player.age, $destroyedShip.debugname ]" />
            </do_else>
            <debug_text
              text="'RR_GetThemBack - Collect SpaceSuits [%s]: Destroyed %s (class: %s, macro: %s, type: %s - %s) at %s(%s), timestamp: %s'.
              [
                player.age,
                $destroyedShip.debugname,
                $destroyedShip.class,
                $destroyedShip.macro,
                $destroyedShip.type,
                $destroyedShip.typename,
                $destroyedAt,
                $destroyedAt.knownname,
                $destroyTimestamp
              ]" />
            <find_ship_by_true_owner name="$spacesuits" faction="faction.player" space="$destroyedAt" class="class.spacesuit" docked="false"
              checkoperational="true"
              multiple="true" />
            <do_for_each name="$spacesuit" in="$spacesuits">
              <debug_text
                text="'RR_GetThemBack - Collect SpaceSuits [%s]: item: %s, age %s, entity: %s '.[ player.age, $spacesuit, $spacesuit.age, $spacesuit.pilot.name]"
                chance="100" />
              <do_if value="$spacesuit.age gt 0.1">
                <debug_text
                  text="'RR_GetThemBack - Collect SpaceSuits [%s]: %s is too old to be collected'.[ player.age, $spacesuit.pilot.name ]"
                  chance="100" />
                <continue />
              </do_if>
              <do_if value="player.entity.$RRData.$indexPre.indexof.{$spacesuit.pilot.name} gt 0">
                <debug_text text="'RR_GetThemBack - Collect SpaceSuits [%s]: %s is already collected'.[ player.age, $spacesuit.pilot.name ]"
                  chance="100" />
                <continue />
              </do_if>
              <set_value name="$dataItem"
                exact="table[
                  $name = $spacesuit.pilot.knownname,
                  $id = $spacesuit.pilot.npctemplate,
                  $container = null,
                  $containerTag = 'spacesuit',
                  $macro = $destroyedShip.macro,
                  $shipId = @$destroyedShip.idcode,
                  $updated = player.age]" />
              <debug_text text="'RR_GetThemBack - Data Item [%s]: %s.'.[ player.age, $dataItem ]" chance="100" />
              <append_to_list name="player.entity.$RRData.$indexPre" exact="$spacesuit.pilot.name" />
              <append_to_list name="player.entity.$RRData.$dataPre" exact="$dataItem" />
              <set_value name="$shipInfo.$countMax" operation="add" />
            </do_for_each>
            <debug_text
              text="'RR_GetThemBack - Collect SpaceSuits [%s]: Destroyed: Macro: %s. Data %s at %s'.
              [
                player.age,
                $destroyedShip.macro,
                $shipInfo,
                player.entity.$RRData.$destroyed.count
              ]"
            />
            <remove_value name="$shipIndex" />
            <remove_value name="$dataItem" />
            <remove_value name="$spacesuits" />
            <remove_value name="$shipInfo" />
            <remove_value name="$destroyTimestamp" />
            <remove_value name="$destroyedAt" />
            <remove_value name="$destroyedShip" />
          </actions>
        </cue>

        <library name="RRDataInit">
          <actions>
            <do_if value="player.entity.$RRData?" negate="true">
              <set_value name="player.entity.$RRData"
                exact="table[
                  $indexPre = [],
                  $dataPre = [],
                  $index = [],
                  $data = [],
                  $destroyed = [],
                  $destroyedIndex = [],
                  $replacements = [],
                  $replacementsIndex = [],
                  $replacementDelayed = [],
                  $pilotsToSwap = []
                ]" />
            </do_if>
          </actions>
        </library>

        <library name="ForwardReconstituteRequest">
          <actions>
            <debug_text
              text="'RR_GetThemBack - ForwardFleetUnitsRequests [%s]: Commander: %s. FleetUnits Count: %s'.[player.age, @event.param2.debugname, @event.param3.count]"
              chance="100" />
            <create_list name="$fleetUnits" />
            <append_list_elements name="$fleetUnits" other="@event.param3" />
            <signal_objects object="player.entity" param="'rr_reconstitute_fleet'" param2="event.param2" param3="$fleetUnits" delay="10ms" />
            <remove_value name="$fleetUnits" />
          </actions>
        </library>

        <cue name="ProcessFleetUnitRequests" instantiate="true" namespace="this">
          <conditions>
            <!-- param2 = requester, param3 = [ships to be replaced] -->
            <event_object_signalled object="player.entity" param="'rr_reconstitute_fleet'" />
            <check_value value="event.param2.isoperational" />
            <check_value value="event.param2.isclass.controllable" />
            <check_value value="not event.param2.fleetunit" />
            <check_value value="@event.param3.count" />
            <check_value value="@player.entity.$RRGetThemBackEnabled + 300 ge player.age" />
          </conditions>
          <actions>
            <set_value name="$commander" exact="event.param2" />
            <do_if value="$commander.commander">
              <set_value name="$commander" exact="$commander.toplevelcommander" />
            </do_if>
            <do_if value="$commander.isclass.ship">
              <debug_text
                text="'RR_GetThemBack - FleetUnitsRequests [%s]: Commander: %s. FleetUnits Count: %s.'.[ player.age, $commander.debugname, event.param3.count]"
                chance="100" />
              <do_if value="player.entity.$RRData? and @player.entity.$RRData.$destroyed.count gt 0">
                <do_for_each name="$fleetUnit" in="event.param3" counter="$fleetUnitIndex">
                  <set_value name="$shipInfo" exact="null" />
                  <debug_text
                    text="'RR_GetThemBack - FleetUnitsRequests [%s]: FleetUnit %s Macro: %s. Destroyed: Count: %s, Data: %s'.
                    [ player.age, $fleetUnitIndex, $fleetUnit.macro, player.entity.$RRData.$destroyed.count, player.entity.$RRData.$destroyed ]" />
                  <do_for_each name="$info" in="player.entity.$RRData.$destroyed" counter="$infoIndex">
                    <do_if value="$info.$macro == $fleetUnit.macro and $info.$commander == null">
                      <set_value name="$shipInfo" exact="$info" />
                      <set_value name="$shipInfo.$commander" exact="$commander" />
                      <set_value name="$shipInfo.$updated" exact="player.age" />
                      <debug_text
                        text="'RR_GetThemBack - FleetUnitsRequests [%s]: Commander Set. Index: %s. ShipInfo: %s.'.
                      [ player.age, $fleetUnitIndex, $shipInfo ]" />
                      <break />
                    </do_if>
                  </do_for_each>
                  <do_if value="$shipInfo != null">
                    <debug_text
                      text="'RR_GetThemBack - FleetUnitsRequests [%s]: Commander %s set for %s via Macro: %s. Record: %s.'.
                      [
                        player.age,
                        $commander.debugname,
                        $shipInfo.$id,
                        $shipInfo.$macro,
                        $shipInfo
                      ]"
                    />
                  </do_if>
                  <do_else>
                    <debug_text
                      text="'RR_GetThemBack - FleetUnitsRequests [%s]: Commander %s not set for %s via Macro: %s.'.
                      [ player.age, $commander.debugname, $fleetUnitIndex, $fleetUnit.macro ]"
                    />
                  </do_else>
                  <remove_value name="$shipInfo" />
                </do_for_each>
              </do_if>
              <do_else>
                <debug_text
                  text="'RR_GetThemBack - Commander %s is not a ship, unable to process fleet unit requests.'.[ player.age, $commander.debugname ]" />
              </do_else>
            </do_if>
            <remove_value name="$commander" />
          </actions>
        </cue>

        <cue name="ProcessCrewAccountingRequest" instantiate="true" namespace="this">
          <conditions>
            <!-- param2 = requester, param3 = [ships to be replaced] -->
            <event_object_signalled object="player.entity" param="'rr_entity_transfer'" />
            <check_value value="event.param2?" />
            <check_value value="@event.param3.$container.isclass.controllable" />
            <check_value value="event.param3.$containerTag?" />
            <check_value value="@player.entity.$RRGetThemBackEnabled + 300 ge player.age" />
          </conditions>
          <actions>
            <debug_text
              text="'RR_GetThemBack - ProcessCrewAccountingRequest started. Game version valid [%s]: %s. Data exists: %s. Param2: %s. Param3: %s. Container: %s, Type: %s'.
              [
                player.age,
                player.gameversion ge 750,
                player.entity.$RRData?,
                @event.param2,
                @event.param3,
                @event.param3.$container,
                @event.param3.$containerTag
              ]"
              chance="100" />
            <do_if value="player.gameversion ge 750 and player.entity.$RRData?">
              <set_value name="$rescuedEntity" exact="event.param2" />
              <set_value name="$rescuedEntityContainer" exact="event.param3.$container" />
              <set_value name="$rescuedEntityContainerTag" exact="event.param3.$containerTag" />
              <do_if value="$rescuedEntityContainerTag == 'rescuer' and @player.entity.$RRData.$indexPre.count gt 0">
                <set_value name="$personIndex" exact="player.entity.$RRData.$indexPre.indexof.{$rescuedEntity}" />
                <do_if value="$personIndex gt 0">
                  <set_value name="$person" exact="player.entity.$RRData.$dataPre.{$personIndex}" />
                  <remove_from_list name="player.entity.$RRData.$dataPre" exact="$person" />
                  <remove_from_list name="player.entity.$RRData.$indexPre" exact="$rescuedEntity" />
                  <set_value name="$person.$container" exact="$rescuedEntityContainer" />
                  <set_value name="$person.$containerTag" exact="$rescuedEntityContainerTag" />
                  <set_value name="$person.$updated" exact="player.age" /> <!-- Set the update timestamp -->
                  <set_value name="$containerPersons" exact="$rescuedEntityContainer.availablepeople.{entityrole.unassigned}.list" />
                  <do_for_each name="$containerPerson" in="$containerPersons">
                    <do_if value="$rescuedEntityContainer.availablepeople.{$containerPerson}.name == $rescuedEntity">
                      <set_value name="$person.$id" exact="$containerPerson" />
                    </do_if>
                  </do_for_each>
                  <append_to_list name="player.entity.$RRData.$index" exact="$rescuedEntity" />
                  <append_to_list name="player.entity.$RRData.$data" exact="$person" />
                  <debug_text
                    text="'RR_GetThemBack - ProcessCrewAccountingRequest [%s]: Person Item moved from spacesuit for %s: %s'.
                    [ player.age, $rescuedEntity, $person ]"
                    chance="100" />
                  <set_value name="$destroyedIndex" exact="player.entity.$RRData.$destroyedIndex.indexof.{$person.$shipId}" />
                  <do_if value="$destroyedIndex gt 0">
                    <set_value name="$shipInfo" exact="player.entity.$RRData.$destroyed.{$destroyedIndex}" />
                    <set_value name="$shipInfo.$count" operation="add" />
                    <debug_text
                      text="'RR_GetThemBack - ProcessCrewAccountingRequest [%s]: Ship Info Item updated: Ship: %s, Index: %s, Info: %s'.
                      [
                        player.age,
                        $shipInfo.$id,
                        $destroyedIndex,
                        $shipInfo
                      ]"
                      chance="100" />
                    <remove_value name="$shipInfo" />
                  </do_if>
                  <do_else>
                    <debug_text
                      text="'RR_GetThemBack - ProcessCrewAccountingRequest [%s]: Ship Info Item not found for %s'.
                      [ player.age, $person.$shipId ]"
                      chance="100" />
                  </do_else>
                  <remove_value name="$person" />
                  <remove_value name="$destroyedIndex" />
                </do_if>
              </do_if>
              <do_elseif value="$rescuedEntityContainerTag == 'dormitory' and @player.entity.$RRData.$index.count gt 0">
                <set_value name="$personIndex" exact="player.entity.$RRData.$index.indexof.{$rescuedEntity}" />
                <do_if value="$personIndex gt 0">
                  <set_value name="player.entity.$RRData.$data.{$personIndex}.$container" exact="$rescuedEntityContainer" />
                  <set_value name="player.entity.$RRData.$data.{$personIndex}.$containerTag" exact="$rescuedEntityContainerTag" />
                  <set_value name="player.entity.$RRData.$data.{$personIndex}.$updated" exact="player.age" /> <!-- Set the update timestamp -->
                  <debug_text
                    text="'RR_GetThemBack - ProcessCrewAccountingRequest [%s]: Data Item Updated for %s: %s'.[ player.age, $rescuedEntity, player.entity.$RRData.$data.{$personIndex} ]"
                    chance="100" />
                </do_if>
                <remove_value name="$personIndex" />
              </do_elseif>
              <remove_value name="$rescuedEntity" />
              <remove_value name="$rescuedEntityContainerTag" />
              <remove_value name="$rescuedEntityContainer" />
            </do_if>
          </actions>
        </cue>

        <cue name="RefreshRRData" instantiate="true" checkinterval="60s" namespace="this">
          <conditions>
            <check_value value="@player.entity.$RRGetThemBackEnabled + 300 ge player.age" />
            <check_any>
              <check_value value="player.entity.$RRData.$data?" />
              <check_value value="player.entity.$RRData.$data?" />
            </check_any>
          </conditions>
          <actions>
            <do_if value="player.entity.$RRData.$dataPre?">
              <set_value name="$dataIndex" exact="1" />
              <do_while value="$dataIndex le player.entity.$RRData.$dataPre.count">
                <set_value name="$dataItem" exact="@player.entity.$RRData.$dataPre.{$dataIndex}" />
                <do_if value="player.age gt ($dataItem.$updated + 1800)">
                  <remove_from_list name="player.entity.$RRData.$indexPre" exact="$dataItem.$name" />
                  <remove_from_list name="player.entity.$RRData.$dataPre" exact="$dataItem" />
                  <debug_text text="'RR_GetThemBack - Refresh Data [%s]: Removed %s from Spacesuits'.[ player.age, $dataItem.$name ]" />
                  <do_if value="$dataIndex == player.entity.$RRData.$dataPre.count">
                    <break />
                  </do_if>
                </do_if>
                <do_else>
                  <set_value name="$dataIndex" operation="add" />
                </do_else>
              </do_while>
            </do_if>
            <do_if value="player.entity.$RRData.$data?">
              <set_value name="$dataIndex" exact="1" />
              <do_while value="$dataIndex le player.entity.$RRData.$data.count">
                <set_value name="$dataItem" exact="@player.entity.$RRData.$data.{$dataIndex}" />
                <do_if value="player.age gt ($dataItem.$updated + 7200)">
                  <remove_from_list name="player.entity.$RRData.$index" exact="$dataItem.$name" />
                  <remove_from_list name="player.entity.$RRData.$data" exact="$dataItem" />
                  <debug_text text="'RR_GetThemBack - Refresh Data [%s]: Removed %s from Dormitories'.[ player.age, $dataItem.$name ]" />
                  <do_if value="$dataIndex == player.entity.$RRData.$data.count">
                    <break />
                  </do_if>
                </do_if>
                <do_else>
                  <set_value name="$dataIndex" operation="add" />
                </do_else>
              </do_while>
            </do_if>
            <!-- TODO: Cleanup destroyed and replacements -->
            <remove_value name="$dataItem" />
            <remove_value name="$dataIndex" />
          </actions>
        </cue>

        <cue name="ReplacementShipBuilded" instantiate="true" namespace="this">
          <conditions>
            <!-- param2 = requester, param3 = [ships to be replaced] -->
            <event_object_signalled object="player.entity" param="'rr_reinstate_fleet_builded'" />
            <check_value value="@event.param2.isclass.controllable" />
            <check_value value="@event.param3.isclass.controllable" />
            <check_value value="@player.entity.$RRGetThemBackEnabled + 300 ge player.age" />
          </conditions>
          <actions>
            <set_value name="$replacement" exact="event.param2" />
            <set_value name="$commander" exact="event.param3" />
            <do_if value="$commander.toplevelcommander">
              <set_value name="$commander" exact="$commander.toplevelcommander" />
            </do_if>
            <debug_text
              text="'RR_GetThemBack - ReplacementShipBuilded [%s]: Data exists: %s. Records count: %s. Input: Commander: %s. Replacement: %s. Macro: %s'.
              [
                player.age,
                player.entity.$RRData?,
                player.entity.$RRData.$index.count,
                $commander.debugname,
                $replacement.debugname,
                $replacement.macro
              ]"
              chance="100" />
            <do_if value="player.entity.$RRData? and @player.entity.$RRData.$destroyed.count gt 0">
              <set_value name="$shipInfo" exact="null" />
              <do_for_each name="$info" in="player.entity.$RRData.$destroyed">
                <do_if value="$info.$macro == $replacement.macro and $info.$commander.idCode == $commander.idcode">
                  <set_value name="$shipInfo" exact="$info" />
                  <set_value name="$shipInfo.$replacement" exact="$replacement" />
                  <break />
                </do_if>
              </do_for_each>
              <debug_text
                text="'RR_GetThemBack - ReplacementShipBuilded [%s]: Commander: %s. Macro: %s. Replacement: %s. Ship Info: %s'.
                [ player.age, $commander.debugname, $replacement.macro, $replacement.debugname, $shipInfo ]"
                chance="100" />
              <do_if value="$shipInfo != null">
                <append_to_list name="player.entity.$RRData.$replacements" exact="$shipInfo" />
                <append_to_list name="player.entity.$RRData.$replacementsIndex" exact="$replacement.idcode" />
                <remove_from_list name="player.entity.$RRData.$destroyed" exact="$shipInfo" />
                <remove_from_list name="player.entity.$RRData.$destroyedIndex" exact="$shipInfo.$id" />
                <debug_text
                  text="'RR_GetThemBack - ReplacementShipBuilded [%s]: ShipInfo: %s is assigned to Replacement ship %s'.[ player.age, $shipInfo, $replacement.debugname ]"
                  chance="100" />
                <break />
              </do_if>
              <do_else>
                <debug_text
                  text="'RR_GetThemBack - ReplacementShipBuilded [%s]: ShipInfo not found for Replacement ship %s'.[ player.age, $replacement.debugname ]"
                  chance="100" />
              </do_else>
              <remove_value name="$shipInfo" />
            </do_if>
            <remove_value name="$replacement" />
            <remove_value name="$commander" />
          </actions>
        </cue>

        <cue name="RecoveryCrewOnReplacementShip" instantiate="true" namespace="this">
          <conditions>
            <!-- param2 = requester, param3 = [ships to be replaced] -->
            <event_object_signalled object="player.entity" param="'rr_reinstate_fleet_ship'" />
            <check_value value="@event.param2.isclass.controllable" />
            <check_value value="@event.param3.isclass.controllable" />
            <check_value value="@player.entity.$RRGetThemBackEnabled + 300 ge player.age" />
          </conditions>
          <actions>
            <set_value name="$replacement" exact="event.param2" />
            <include_actions ref="ProcessRecoveryCrew" />
            <remove_value name="$replacement" />
          </actions>
        </cue>

        <library name="ProcessRecoveryCrew">
          <actions>
            <set_value name="$commander" exact="@$replacement.commander" />
            <do_if value="@$replacement.toplevelcommander">
              <set_value name="$commander" exact="@$replacement.toplevelcommander" />
            </do_if>
            <debug_text
              text="'RR_GetThemBack - RecoveryCrew [%s]: Data exists: %s. Records count: %s. Input: Commander: %s. Replacement: %s. Macro: %s'.
              [
                player.age,
                player.entity.$RRData?,
                player.entity.$RRData.$index.count,
                @$commander.debugname,
                $replacement.debugname,
                $replacement.macro
              ]"
              chance="100" />
            <do_if value="player.entity.$RRData? and @player.entity.$RRData.$replacementsIndex.count gt 0">
              <set_value name="$replacementIndex" exact="player.entity.$RRData.$replacementsIndex.indexof.{$replacement.idcode}" />
              <debug_text text="'RR_GetThemBack - RecoveryCrew [%s]: Replacement Index: %s'.[ player.age, $replacementIndex ]" chance="100" />
              <do_if value="$replacementIndex gt 0">
                <set_value name="$shipInfo" exact="player.entity.$RRData.$replacements.{$replacementIndex}" />
                <debug_text
                  text="'RR_GetThemBack - RecoveryCrew [%s]: Replacement Data: %s. Count: %s'.[ player.age, $shipInfo,  $shipInfo.count]"
                  chance="100" />
                <do_if value="@$shipInfo != null and $shipInfo.$count lt $shipInfo.$countMax">
                  <debug_text
                    text="'RR_GetThemBack - RecoveryCrew [%s]: Not all crew members are recovered yet. Max: %s. Count: %s'.
                    [ player.age, $shipInfo.$countMax, $shipInfo.$count ]"
                    chance="100" />
                  <do_if value="player.entity.$RRData.$replacementDelayed.indexof.{$replacement.idcode} gt 0">
                    <debug_text
                      text="'RR_GetThemBack - RecoveryCrew [%s]: Replacement ship %s is already in the delayed list'.
                        [ player.age, $replacement.debugname ]"
                      chance="100" />
                  </do_if>
                  <do_else>
                    <append_to_list name="player.entity.$RRData.$replacementDelayed" exact="$replacement.idcode" />
                    <debug_text
                      text="'RR_GetThemBack - RecoveryCrew [%s]: Replacement ship %s added to the delayed list'.
                            [ player.age, $replacement.debugname ]"
                      chance="100" />
                  </do_else>
                </do_if>
                <do_elseif value="@$shipInfo != null">
                  <debug_text
                    text="'RR_GetThemBack - RecoveryCrew [%s]: ShipInfo: %s, Ship: %s, Macro: %s, ID: %s'.
                    [
                      player.age,
                      @$shipInfo,
                      $replacement.debugname,
                      $replacement.macro,
                      @$shipInfo.$id
                    ]"
                    chance="100" />
                  <do_if value="player.entity.$RRData? and @player.entity.$RRData.$index.count gt 0">
                    <set_value name="$data" exact="player.entity.$RRData.$data" />
                    <create_list name="$replacementCrew" />
                    <set_value name="$personIndex" exact="1" />
                    <do_while value="$personIndex le $data.count">
                      <set_value name="$person" exact="$data.{$personIndex}" />
                      <do_if value="@$person.$shipId == @$shipInfo.$id and @$person.$macro == $replacement.macro ">
                        <remove_from_list name="player.entity.$RRData.$data" exact="$person" />
                        <remove_from_list name="player.entity.$RRData.$index" exact="$person.$name" />
                        <debug_text
                          text="'RR_GetThemBack - RecoveryCrew [%s]: Person added to replacement crew: %s'.[ player.age, $person ]"
                          chance="100" />
                        <debug_text text="'RR_GetThemBack - RecoveryCrew [%s]: Crew member: %s'.[ player.age, $person ]" chance="100" />
                      </do_if>
                      <do_else>
                        <set_value name="$personIndex" operation="add" />
                      </do_else>
                      <remove_value name="$person" />
                    </do_while>
                    <remove_value name="$personIndex" />
                    <debug_text
                      text="'RR_GetThemBack - RecoveryCrew [%s]: Replacement crew count: %s'.[ player.age, $replacementCrew.count ]"
                      chance="100" />
                    <do_if value="@$replacementCrew.count gt 0">
                      <debug_text text="'RR_GetThemBack - RecoveryCrew [%s]: Replacement crew: %s'.[ player.age, $replacementCrew ]"
                        chance="100" />
                      <sort_list list="$replacementCrew"
                        sortbyvalue="loop.element.$container.availablepeople.{loop.element.$id}.skill.piloting"
                        sortdescending="true" />
                      <debug_text
                        text="'RR_GetThemBack - RecoveryCrew [%s]: Best Pilot: %s. Skill: %s'.
                        [player.age, @$replacementCrew.{1}.$name, @$replacementCrew.{1}.$container.availablepeople.{@$replacementCrew.{1}.$id}.skill.piloting]"
                        chance="100" />
                      <debug_text
                        text="'RR_GetThemBack - RecoveryCrew [%s]: CurrentPilot %s. Role: %s. Post: %s'.
                        [
                          player.age,
                          @$replacement.aipilot.name,
                          @$replacement.aipilot.role.name,
                          @$replacement.aipilot.controlpost.name,
                        ]"
                        chance="100" />
                      <set_value name="$pilotNew" exact="null" />
                      <do_if
                        value="$replacementCrew.{1}? and @$replacementCrew.{1}.$container.availablepeople.{@$replacementCrew.{1}.$id}.skill.piloting gt $replacement.aipilot.skill.piloting">
                        <set_value name="$pilotNew" exact="$replacementCrew.{1}" />
                        <remove_from_list name="$replacementCrew" exact="$pilotNew" />
                      </do_if>
                      <debug_text
                        text="'RR_GetThemBack - RecoveryCrew [%s]: Current crew: %s. Count: %s. Capacity: %s. Free: %s. Count: %s.'.
                        [
                          player.age,
                          $replacement.availablepeople.list,
                          $replacement.availablepeople.count,
                          $replacement.people.capacity,
                          $replacement.people.free,
                          $replacement.people.count
                        ]"
                        chance="100" />
                      <create_list name="$crewLocal" />
                      <do_for_each name="$person" in="$replacement.availablepeople.list">
                        <debug_text
                          text="'RR_GetThemBack - RecoveryCrew [%s]: Person: %s. Role: %s. Control Post: %s'.
                           [ player.age, $person, @$replacement.people.{$person}.role.name, @$replacement.people.{$person}.controlpost.name ]"
                          chance="100" />
                        <do_if value="$replacement.availablepeople.{$person}.role == entityrole.unassigned" negate="true">
                          <set_npc_template_role object="$replacement" template="$person" role="entityrole.unassigned" />
                        </do_if>
                        <append_to_list name="$crewLocal" exact="$person" />
                      </do_for_each>
                      <set_value name="$crewDelta" exact="$replacementCrew.count - $replacement.people.free" />
                      <do_if value="$pilotNew? and @$pilotNew != null">
                        <set_value name="$crewDelta" operation="add" />
                      </do_if>
                      <debug_text
                        text="'RR_GetThemBack - RecoveryCrew [%s]: Crew Delta: %s. New Crew Count: %s. Existing Crew: %s. Free: %s. To Clear: %s'.
                        [
                          player.age,
                          $crewDelta,
                          $replacementCrew.count,
                          $replacement.people.count,
                          $replacement.people.free,
                          ($replacementCrew.count gt 0 or $crewLocal.count gt 0) and $crewDelta gt 0
                        ]"
                        chance="100" />
                      <do_if value="($replacementCrew.count gt 0 or $crewLocal.count gt 0) and $crewDelta gt 0">
                        <debug_text
                          text="'RR_GetThemBack - RecoveryCrew [%s]: Not enough space for the replacement Crew. Delta: %s. But we can fire some one...'.
                          [
                            player.age,
                            $crewDelta,
                          ]"
                          chance="100" />
                        <sort_list list="$crewLocal" sortbyvalue="$replacement.availablepeople.{loop.element}.combinedskill"
                          sortdescending="false" />
                        <sort_list list="$replacementCrew"
                          sortbyvalue="@loop.element.$container.availablepeople.{loop.element.$id}.combinedskill"
                          sortdescending="false" />
                        <do_while value="$crewDelta gt 0 and ($replacementCrew.count gt 0 or $crewLocal.count gt 0)">
                          <do_if value="$crewLocal.count gt 0 and $replacementCrew.count gt 0">
                            <set_value name="$personLowestLocal" exact="$crewLocal.{1}" />
                            <set_value name="$personLowestNew" exact="$replacementCrew.{1}" />
                            <debug_text
                              text="'RR_GetThemBack - RecoveryCrew [%s]: Lowest persons: Local: %s - %s, New: %s - %s'.
                              [
                                player.age,
                                @$replacement.availablepeople.{$personLowestLocal}.name,
                                @$replacement.availablepeople.{$personLowestLocal}.combinedskill,
                                @$personLowestNew.$container.availablepeople.{$personLowestNew.$id}.name,
                                @$personLowestNew.$container.availablepeople.{$personLowestNew.$id}.combinedskill
                              ]"
                              chance="100" />
                            <do_if
                              value="@$replacement.availablepeople.{$personLowestLocal}.combinedskill lt @$personLowestNew.$container.availablepeople.{$personLowestNew.$id}.combinedskill">
                              <remove_from_list name="$crewLocal" exact="$personLowestLocal" />
                              <debug_text
                                text="'RR_GetThemBack - RecoveryCrew [%s]: Person to fire: %s'.
                                [ player.age, @$replacement.availablepeople.{$personLowestLocal}.name ]"
                                chance="100" />
                              <remove_npc_template object="$replacement" template="$personLowestLocal" />
                            </do_if>
                            <do_else>
                              <remove_from_list name="$replacementCrew" exact="$personLowestNew" />
                              <debug_text
                                text="'RR_GetThemBack - RecoveryCrew [%s]: Person to fire: %s'.
                                [ player.age, @$personLowestNew.$container.availablepeople.{$personLowestNew.$id}.name ]"
                                chance="100" />
                              <remove_from_list name="$replacementCrew" exact="$personLowestNew" />
                              <!-- <remove_npc_template object="@$personLowestNew.$container" template="$personLowestNew.$id" /> Will not
                              delete. It was rescued -->
                            </do_else>
                            <remove_value name="$personLowestLocal" />
                            <remove_value name="$personLowestNew" />
                          </do_if>
                          <do_elseif value="$replacementCrew.count gt 0">
                            <set_value name="$personLowestNew" exact="$replacementCrew.{1}" />
                            <debug_text
                              text="'RR_GetThemBack - RecoveryCrew [%s]: Person to fire: %s'.
                              [ player.age, @$personLowestNew.$container.availablepeople.{$personLowestNew.$id}.name ]"
                              chance="100" />
                            <remove_from_list name="$replacementCrew" exact="$personLowestNew" />
                            <!-- <remove_npc_template object="@$personLowestNew.$container" template="$personLowestNew.$id" /> Will not
                            delete. It was rescued -->
                          </do_elseif>
                          <do_else>
                            <set_value name="$personLowestLocal" exact="$crewLocal.{1}" />
                            <debug_text
                              text="'RR_GetThemBack - RecoveryCrew [%s]: Person to fire: %s'.
                              [ player.age, @$replacement.availablepeople.{$personLowestLocal}.name ]"
                              chance="100" />
                            <remove_from_list name="$crewLocal" exact="$personLowestLocal" />
                            <remove_npc_template object="$replacement" template="$personLowestLocal" />
                            <remove_value name="$personLowestLocal" />
                          </do_else>
                          <set_value name="$crewDelta" operation="subtract" />
                        </do_while>
                      </do_if>
                      <remove_value name="$crewDelta" />
                      <remove_value name="$crewLocal" />
                      <do_if value="$replacementCrew.count gt 0">
                        <sort_list list="$replacementCrew" sortbyvalue="@loop.element.$container.idcode" />
                        <set_value name="$dormitory" exact="$replacementCrew.{1}.$container" />
                        <create_list name="$crewToTransfer" />
                        <do_for_each name="$crewMember" in="$replacementCrew">
                          <do_if value="$dormitory.idcode == $crewMember.$container.idcode">
                            <append_to_list name="$crewToTransfer" exact="$crewMember" />
                          </do_if>
                          <do_else>
                            <include_actions ref="TransferCrewFromDormitory" />
                          </do_else>
                        </do_for_each>
                        <include_actions ref="TransferCrewFromDormitory" />
                        <remove_value name="$crewToTransfer" />
                      </do_if>
                      <do_else>
                        <debug_text
                          text="'RR_GetThemBack - RecoveryCrew [%s]: Nobody transferred to %s'.[ player.age, $replacement.debugname ]"
                          chance="100" />
                      </do_else>
                      <debug_text
                        text="'RR_GetThemBack - RecoveryCrew [%s]: Current Pilot: %s. Skill: %s'.
                          [ player.age, $replacement.aipilot.knownname, $replacement.aipilot.skill.piloting ]"
                        chance="100" />
                      <do_if value="$pilotNew? and @$pilotNew != null">
                        <transfer_people result="$crewTransferred" object="$replacement" otherobject="$pilotNew.$container"
                          receiveworkforce="false">
                          <existing_people people="[$pilotNew.$id]" />
                        </transfer_people>
                        <debug_text
                          text="'RR_GetThemBack - RecoveryCrew [%s]: Pilot transferred: %s'.
                           [ player.age, $crewTransferred.count gt 0 and $pilotNew.$id == $crewTransferred.{1}]"
                          chance="100" />
                        <do_if value="$crewTransferred.count gt 0 and $pilotNew.$id == $crewTransferred.{1}">
                          <assign_hired_actor actor="[$replacement, $pilotNew.$id]" target="$replacement"
                            post="controlpost.aipilot" success="$pilotsSwappingResult" failed="$pilotsSwappingMessage" />
                          <debug_text
                            text="'RR_GetThemBack - RecoveryCrew [%s]: Swap Pilots: Result: %s. Message: %s'.[ player.age, $pilotsSwappingResult, $pilotsSwappingMessage ]"
                            chance="100" />
                          <do_if value="$pilotsSwappingResult" negate="true">
                            <append_to_list name="player.entity.$RRData.$pilotsToSwap"
                              exact="table[$ship = $replacement, $shipId = $replacement.idcode, $pilot = $pilotNew.$id, $updated = player.age]" />
                            <debug_text
                              text="'RR_GetThemBack - RecoveryCrew [%s]: Pilot to swap added: %s'.
                                [ player.age,@player.entity.$RRData.$pilotsToSwap.last]"
                              chance="100" />
                          </do_if>
                        </do_if>
                        <do_else>
                          <debug_text text="'RR_GetThemBack - RecoveryCrew [%s]: Pilot not transferred: %s'.[ player.age, $pilotNew.$id ]"
                            chance="100" />
                        </do_else>
                      </do_if>
                      <set_value name="$crewUnassigned" exact="$replacement.availablepeople.{entityrole.unassigned}.list" />
                      <set_value name="$lastMarine" exact="false" />
                      <do_for_each name="$crewMember" in="$crewUnassigned">
                        <do_if value="$replacement.availablepeople.{$crewMember}.combinedskill == 0">
                          <do_if value="$lastMarine">
                            <set_npc_template_role template="$crewMember" object="$replacement" role="entityrole.service" />
                          </do_if>
                          <do_else>
                            <set_npc_template_role template="$crewMember" object="$replacement" role="entityrole.marine" />
                          </do_else>
                          <set_value name="$lastMarine" exact="not $lastMarine" />
                        </do_if>
                        <do_else>
                          <do_if
                            value="$replacement.availablepeople.{$crewMember}.skill.engineering gt $replacement.availablepeople.{$crewMember}.skill.boarding">
                            <set_npc_template_role template="$crewMember" object="$replacement" role="entityrole.service" />
                            <debug_text
                              text="'RR_GetThemBack - RecoveryCrew [%s]: Crew member %s assigned as Service Man'.
                              [ player.age, $replacement.availablepeople.{$crewMember}.name ]"
                              chance="100" />
                          </do_if>
                          <do_else>
                            <set_npc_template_role template="$crewMember" object="$replacement" role="entityrole.marine" />
                            <debug_text
                              text="'RR_GetThemBack - RecoveryCrew [%s]: Crew member %s assigned as Marine'.
                              [ player.age, $replacement.availablepeople.{$crewMember}.name ]"
                              chance="100" />
                          </do_else>
                        </do_else>
                      </do_for_each>
                      <remove_value name="$lastMarine" />
                      <remove_value name="$crewMember" />
                    </do_if>
                    <do_else>
                      <debug_text text="'RR_GetThemBack - RecoveryCrew [%s]: No crew assigned'" chance="100" />
                    </do_else>
                    <remove_value name="$replacementCrew" />
                    <remove_value name="$data" />
                  </do_if>
                  <do_else>
                    <debug_text text="'RR_GetThemBack - RecoveryCrew [%s]: No data for recovery'" chance="100" />
                  </do_else>
                </do_elseif>
                <do_else>
                  <debug_text
                    text="'RR_GetThemBack - RecoveryCrew [%s]: No data for recovery found by Replacement Id : %s for Commander: %s'.
                    [player.age, $replacement.debugname, @$commander.debugname]"
                    chance="100" />
                </do_else>
                <remove_value name="$shipInfo" />
              </do_if>
              <do_else>
                <debug_text
                  text="'RR_GetThemBack - RecoveryCrew [%s]: Replacement %s not in a list: %s'.[ player.age, $replacement.debugname, player.entity.$RRData.$replacements]"
                  chance="100" />
              </do_else>
              <remove_value name="$replacementIndex" />
            </do_if>
            <remove_value name="$commander" />
          </actions>
        </library>

        <library name="TransferCrewFromDormitory">
          <actions>
            <do_if value="$crewToTransfer.count gt 0">
              <debug_text
                text="'RR_GetThemBack - RecoveryCrew [%s]: Counted %s crew member on %s.'.
                [ player.age, $crewToTransfer.count, $dormitory.debugname ]"
                chance="100" />
              <transfer_people result="$crewTransferred" object="$replacement" otherobject="$dormitory"
                receiveworkforce="false">
                <existing_people people="$crewToTransfer" />
              </transfer_people>
              <debug_text
                text="'RR_GetThemBack - RecoveryCrew [%s]: Crew transferred: Count: %s, Data: %s'.
                [ player.age, $crewTransferred.count, $crewTransferred ]"
                chance="100" />
              <clear_list list="$crewTransferred" />
              <remove_value name="$crewTransferred" />
            </do_if>
            <do_else>
              <debug_text
                text="'RR_GetThemBack - RecoveryCrew [%s]: No crew members to transfer from %s.'.
                [ player.age, $dormitory.debugname ]"
                chance="100" />
            </do_else>
            <set_value name="$dormitory" exact="$crewMember.$container" />
            <clear_list list="$crewToTransfer" />
          </actions>
        </library>

        <cue name="ProcessDelayedReplacements" instantiate="true" checkinterval="30s" namespace="this">
          <conditions>
            <check_value value="@player.entity.$RRData.$replacementDelayed.count gt 0" />
          </conditions>
          <actions>
            <set_value name="$delayedIndex" exact="1" />
            <do_while value="$delayedIndex le @player.entity.$RRData.$replacementDelayed.count">
              <set_value name="$replacementId" exact="@player.entity.$RRData.$replacementDelayed.{$delayedIndex}" />
              <debug_text
                text="'RR_GetThemBack - ProcessDelayedReplacements [%s]: Processing replacement %s'.[ player.age, $replacementId ]"
                chance="100" />
              <set_value name="$replacementIndex" exact="@player.entity.$RRData.$replacementsIndex.indexof.{$replacementId}" />
              <do_if value="$replacementIndex gt 0">
                <set_value name="$shipInfo" exact="@player.entity.$RRData.$replacements.{$replacementIndex}" />
                <debug_text
                  text="'RR_GetThemBack - ProcessDelayedReplacements [%s]: Ship Info: %s at %s'.[ player.age, $shipInfo,  $replacementIndex]"
                  chance="100" />
                <do_if value="$shipInfo.$count == $shipInfo.$countMax">
                  <debug_text
                    text="'RR_GetThemBack - ProcessDelayedReplacements [%s]: All crew members are recovered for %s'.[ player.age, $shipInfo.debugname ]"
                    chance="100" />
                  <remove_from_list name="@player.entity.$RRData.$replacementDelayed" exact="$replacementId" />
                  <set_value name="$replacement" exact="$shipInfo.$replacement" />
                  <do_if value="@$replacement != null">
                    <debug_text
                      text="'RR_GetThemBack - ProcessDelayedReplacements [%s]: Replacement ship found: %s'.[ player.age, $replacement.debugname ]"
                      chance="100" />
                    <include_actions ref="ProcessRecoveryCrew" />
                    <remove_value name="$replacement" />
                    <remove_value name="$replacementShips" />
                  </do_if>
                  <do_else>
                    <debug_text
                      text="'RR_GetThemBack - ProcessDelayedReplacements [%s]: Replacement ship with id %s not found for %s'.[ player.age, $replacementId, $shipInfo.$id ]"
                      chance="100" />
                  </do_else>
                </do_if>
                <do_else>
                  <debug_text
                    text="'RR_GetThemBack - ProcessDelayedReplacements [%s]: Not all crew members are recovered yet for %s'.[ player.age, $shipInfo.debugname ]"
                    chance="100" />
                  <set_value name="$delayedIndex" operation="add" />
                </do_else>
                <remove_value name="$shipInfo" />
              </do_if>
              <do_else>
                <debug_text
                  text="'RR_GetThemBack - ProcessDelayedReplacements [%s]: Replacement %s not found in the list'.[ player.age, $replacementId ]"
                  chance="100" />
                <remove_from_list name="@player.entity.$RRData.$replacementDelayed" exact="$replacementId" />
              </do_else>
              <remove_value name="$replacementIndex" />
              <remove_value name="$replacementId" />
            </do_while>
            <remove_value name="$delayedIndex" />
          </actions>
        </cue>


        <cue name="SwapPilots" instantiate="true" checkinterval="5s" namespace="this">
          <conditions>
            <check_value value="@player.entity.$RRData.$pilotsToSwap.count gt 0" />
          </conditions>
          <actions>
            <set_value name="$swapIndex" exact="1" />
            <do_while value="$swapIndex le @player.entity.$RRData.$pilotsToSwap.count">
              <set_value name="$swapInfo" exact="@player.entity.$RRData.$pilotsToSwap.{$swapIndex}" />
              <debug_text text="'RR_GetThemBack - SwapPilots [%s]: Swapping pilots record %s'.
                [ player.age, $swapInfo ]"
                chance="100" />
              <do_if value="@$swapInfo.$ship.isoperational">
                <assign_hired_actor actor="[$swapInfo.$ship, $swapInfo.$pilot]" target="$swapInfo.$ship"
                  post="controlpost.aipilot" success="$pilotsSwappingResult" failed="$pilotsSwappingMessage" />
                <do_if value="$pilotsSwappingResult">
                  <debug_text
                    text="'RR_GetThemBack - SwapPilots [%s]: Pilot %s swapped on %s.'.
                    [ player.age, @$swapInfo.$ship.aipilot.knownname, $swapInfo.$ship.debugname ]"
                    chance="100" />
                  <remove_from_list name="@player.entity.$RRData.$pilotsToSwap" exact="$swapInfo" />
                </do_if>
                <do_else>
                  <debug_text
                    text="'RR_GetThemBack - RecoveryCrew [%s]: Pilot swap failed: %s'.[ player.age, $pilotsSwappingMessage]" chance="100" />
                  <do_if value="$swapInfo.$updated + 300 lt player.age">
                    <remove_from_list name="@player.entity.$RRData.$pilotsToSwap" exact="$swapInfo" />
                    <debug_text
                      text="'RR_GetThemBack - SwapPilots [%s]: Pilot swap record removed: %s'.
                      [ player.age, $swapInfo ]"
                      chance="100" />
                  </do_if>
                  <do_else>
                    <set_value name="$swapIndex" operation="add" />
                  </do_else>
                </do_else>
              </do_if>
              <do_else>
                <remove_from_list name="@player.entity.$RRData.$pilotsToSwap" exact="$swapInfo" />
                <debug_text
                  text="'RR_GetThemBack - SwapPilots [%s]: Ship %s is not operational. Pilot swap record removed: %s'.
                  [ player.age, $swapInfo.$ship.debugname, $swapInfo ]"
                  chance="100" />
              </do_else>
            </do_while>
            <remove_value name="$swapInfo" />
            <remove_value name="$swapIndex" />
            <remove_value name="$pilotsSwappingResult" />
            <remove_value name="$pilotsSwappingMessage" />
          </actions>
        </cue>

      </cues>
    </cue>
  </cues>
</mdscript>